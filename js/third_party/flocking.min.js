
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";var $=fluid.registerNamespace("jQuery");flock.init=function(options){var enviroOpts=!options?undefined:{audioSettings:options};flock.enviro.shared=flock.enviro(enviroOpts);};flock.OUT_UGEN_ID="flocking-out";flock.TWOPI=2.0*Math.PI;flock.LOG01=Math.log(0.1);flock.LOG001=Math.log(0.001);flock.ROOT2=Math.sqrt(2);flock.rates={AUDIO:"audio",CONTROL:"control",DEMAND:"demand",CONSTANT:"constant"};flock.sampleFormats={FLOAT32NE:"float32NE"};fluid.registerNamespace("flock.platform");flock.platform.isBrowser=typeof(window)!=="undefined";flock.platform.os=flock.platform.isBrowser?window.navigator.platform:fluid.require("os").platform();flock.platform.isLinuxBased=flock.platform.os.indexOf("Linux")>-1||flock.platform.os.indexOf("Android")>-1;flock.platform.browser=flock.platform.isBrowser?jQuery.browser:{};flock.platform.isWebAudio=(typeof(AudioContext)!=="undefined"&&(new AudioContext()).createJavaScriptNode)||typeof(webkitAudioContext)!=="undefined";flock.platform.audioEngine=flock.platform.isBrowser?(flock.platform.isWebAudio?"webAudio":"moz"):"nodejs";fluid.staticEnvironment.audioEngine=fluid.typeTag("flock.platform."+flock.platform.audioEngine);flock.isIterable=function(o){return o&&o.length!==undefined&&typeof(o.length)==="number";};flock.generate=function(bufOrSize,generator){var buf=typeof(bufOrSize)==="number"?new Float32Array(bufOrSize):bufOrSize,i;if(typeof(generator)==="number"){var value=generator;generator=function(){return value;};}
for(i=0;i<buf.length;i++){buf[i]=generator(i,buf);}
return buf;};flock.generate.silence=function(bufOrSize){if(typeof(bufOrSize)==="number"){return new Float32Array(bufOrSize);}
var buf=bufOrSize,i;for(i=0;i<buf.length;i++){buf[i]=0.0;}
return buf;};flock.minBufferSize=function(latency,audioSettings){var size=(audioSettings.rates.audio*audioSettings.chans)/(1000/latency);return Math.round(size);};flock.randomIndex=function(arr){var max=arr.length-1;return Math.round(Math.random()*max);};flock.arrayChoose=function(arr,strategy){strategy=strategy||flock.randomIndex;arr=fluid.makeArray(arr);var idx=strategy(arr);return arr[idx];};flock.choose=function(collection,strategy){if(flock.isIterable(collection)){var val=flock.arrayChoose(collection,strategy);return val;}
var key=flock.arrayChoose(collection.keys,strategy);return collection[key];};flock.normalize=function(buffer,normal){var maxVal=0.0,i,current,val;normal=normal===undefined?1.0:normal;for(i=0;i<buffer.length;i++){current=Math.abs(buffer[i]);if(current>maxVal){maxVal=current;}}
if(maxVal>0.0){for(i=0;i<buffer.length;i++){val=buffer[i];buffer[i]=(val/maxVal)*normal;}}
return buffer;};flock.range=function(buf){var range={max:Number.NEGATIVE_INFINITY,min:Infinity};var i,val;for(i=0;i<buf.length;i++){val=buf[i];if(val>range.max){range.max=val;}
if(val<range.min){range.min=val;}}
return range;};flock.scale=function(buf,minVal,maxVal){if(!buf){return;}
var range=flock.range(buf),mul=(range.max-range.min)/2,sub=(range.max+range.min)/2,i;for(i=0;i<buf.length;i++){buf[i]=(buf[i]-sub)/mul;}
return buf;};flock.interpolate={};flock.interpolate.linear=function(idx,table){idx=idx%table.length;var i1=idx|0,i2=(i1+1)%table.length,frac=idx-i1,y1=table[i1],y2=table[i2];return y1+frac*(y2-y1);};flock.interpolate.cubic=function(idx,table){idx=idx%table.length;var len=table.length,i1=idx|0,i0=i1>0?i1-1:len-1,i2=(i1+1)%len,i3=(i1+2)%len,frac=idx-i1,fracSq=frac*frac,fracCub=frac*fracSq,y0=table[i0],y1=table[i1],y2=table[i2],y3=table[i3],a=0.5*(y1-y2)+(y3-y0),b=(y0+y2)*0.5-y1,c=y2-(0.3333333333333333*y0)-(0.5*y1)-(0.16666666666666667*y3);return(a*fracCub)+(b*fracSq)+(c*frac)+y1;};flock.pathParseError=function(path,token){throw new Error("Error parsing path: "+path+". Segment '"+token+"' could not be resolved.");};flock.get=function(root,path){if(!root){return fluid.getGlobalValue(path);}else if(arguments.length==1&&typeof(root)==="string"){return fluid.getGlobalValue(root);}
if(!path||path===""){return;}
var tokenized=path===""?[]:String(path).split("."),valForSeg=root[tokenized[0]],i;for(i=1;i<tokenized.length;i++){if(valForSeg===null||valForSeg===undefined){flock.pathParseError(path,tokenized[i-1]);}
valForSeg=valForSeg[tokenized[i]];}
return valForSeg;};flock.set=function(root,path,value){if(!root||!path||path===""){return;}
var tokenized=String(path).split("."),l=tokenized.length,prop=tokenized[0],i,type;for(i=1;i<l;i++){root=root[prop];type=typeof(root);if(type!=="object"){throw new Error("A non-container object was found at segment "+prop+". Value: "+root);}
prop=tokenized[i];if(root[prop]===undefined){root[prop]={};}}
root[prop]=value;return value;};flock.invoke=function(root,path,args){var fn=typeof(root)==="function"?root:flock.get(root,path);if(typeof(fn)!=="function"){throw new Error("Path '"+path+"' does not resolve to a function.");}
return fn.apply(null,args);};flock.input={};flock.input.pathExpander=function(path){return path.replace(/\.(?![0-9])/g,".inputs.");};flock.input.expandPaths=function(paths){var expanded={},path,expandedPath,value;for(path in paths){expandedPath=flock.input.pathExpander(path);value=paths[path];expanded[expandedPath]=value;}
return expanded;};flock.input.expandPath=function(path){return(typeof(path)==="string")?flock.input.pathExpander(path):flock.input.expandPaths(path);};flock.input.getValueForPath=function(root,path){path=flock.input.expandPath(path);var input=flock.get(root,path);return(input&&input.model&&typeof(input.model.value)!=="undefined")?input.model.value:input;};flock.input.getValuesForPathArray=function(root,paths){var values={},i,path;for(i=0;i<paths.length;i++){path=paths[i];values[path]=flock.input.get(root,path);}
return values;};flock.input.getValuesForPathObject=function(root,pathObj){var key;for(key in pathObj){pathObj[key]=flock.input.get(root,key);}
return pathObj;};flock.input.get=function(root,path){return typeof(path)==="string"?flock.input.getValueForPath(root,path):flock.isIterable(path)?flock.input.getValuesForPathArray(root,path):flock.input.getValuesForPathObject(root,path);};flock.input.setValueForPath=function(root,path,val,baseTarget,valueParser){path=flock.input.expandPath(path);var previousInput=flock.get(root,path),lastDotIdx=path.lastIndexOf("."),inputName=path.slice(lastDotIdx+1),target=lastDotIdx>-1?flock.get(root,path.slice(0,path.lastIndexOf(".inputs"))):baseTarget,newInput=valueParser?valueParser(val,path,target,previousInput):val;flock.set(root,path,newInput);if(target&&target.onInputChanged){target.onInputChanged(inputName);}
return newInput;};flock.input.setValuesForPaths=function(root,valueMap,baseTarget,valueParser){var resultMap={},path,val,result;for(path in valueMap){val=valueMap[path];result=flock.input.set(root,path,val,baseTarget,valueParser);resultMap[path]=result;}
return resultMap;};flock.input.set=function(root,path,val,baseTarget,valueParser){return typeof(path)==="string"?flock.input.setValueForPath(root,path,val,baseTarget,valueParser):flock.input.setValuesForPaths(root,path,baseTarget,valueParser);};fluid.defaults("flock.nodeList",{gradeNames:["fluid.littleComponent","autoInit"],members:{nodes:[],namedNodes:{}}});flock.nodeList.preInit=function(that){that.head=function(node){that.nodes.unshift(node);that.namedNodes[node.nickName]=node;};that.before=function(refNode,node){var refIdx=that.nodes.indexOf(refNode);that.at(refIdx,node);};that.after=function(refNode,node){var refIdx=that.nodes.indexOf(refNode);that.at(refIdx+1,node);};that.at=function(idx,node){that.nodes.splice(idx,0,node);that.namedNodes[node.nickName]=node;};that.tail=function(node){that.nodes.push(node);that.namedNodes[node.nickName]=node;};that.remove=function(node){var idx=that.nodes.indexOf(node);that.nodes.splice(idx,1);delete that.namedNodes[node.nickName];};};fluid.defaults("flock.enviro",{gradeNames:["fluid.modelComponent","flock.nodeList","autoInit"],model:{playState:{written:0,total:null},isPlaying:false},audioSettings:{rates:{audio:44100,control:64,constant:1},chans:2,numBuses:2,bufferSize:(flock.platform.os==="Win32"&&flock.platform.browser.mozilla)?16384:4096,genPollIntervalFactor:flock.platform.isLinuxBased?1:20},components:{asyncScheduler:{type:"flock.scheduler.async"},audioStrategy:{type:"flock.enviro.audioStrategy",options:{audioSettings:"{enviro}.options.audioSettings",model:{playState:"{enviro}.model.playState"}}}}});flock.enviro.preInit=function(that){that.audioSettings=that.options.audioSettings;that.buses=flock.enviro.createAudioBuffers(that.audioSettings.numBuses,that.audioSettings.rates.control);that.buffers={};that.play=function(dur){dur=dur===undefined?Infinity:dur;var playState=that.model.playState,sps=dur*that.audioSettings.rates.audio*that.audioSettings.chans;playState.total=playState.written+sps;that.audioStrategy.startGeneratingSamples();that.model.isPlaying=true;};that.stop=function(){that.audioStrategy.stopGeneratingSamples();that.model.isPlaying=false;};that.reset=function(){that.stop();that.asyncScheduler.clearAll();while(that.nodes.length>0){that.nodes.pop();}};that.loadBuffer=function(name,src,onLoadFn){if(!src&&onLoadFn){onLoadFn(that.buffers[name],name);return;}
flock.audio.decode(src,function(decoded){var chans=decoded.data.channels;that.buffers[name]=chans;if(onLoadFn){onLoadFn(chans,name);}});};};flock.enviro.finalInit=function(that){that.gen=that.audioStrategy.nodeEvaluator.gen;that.options.audioSettings.rates.audio=that.audioStrategy.options.audioSettings.rates.audio;};flock.enviro.createAudioBuffers=function(numBufs,kr){var bufs=[],i;for(i=0;i<numBufs;i++){bufs[i]=new Float32Array(kr);}
return bufs;};fluid.defaults("flock.enviro.audioStrategy",{gradeNames:["fluid.modelComponent"],components:{nodeEvaluator:{type:"flock.enviro.nodeEvaluator",options:{numBuses:"{enviro}.options.audioSettings.numBuses",controlRate:"{enviro}.options.audioSettings.rates.control",members:{buses:"{enviro}.buses",nodes:"{enviro}.nodes"}}}}});fluid.defaults("flock.enviro.nodeEvaluator",{gradeNames:["fluid.littleComponent","autoInit"]});flock.enviro.nodeEvaluator.finalInit=function(that){that.gen=function(){var numBuses=that.options.numBuses,busLen=that.options.controlRate,i,bus,j,node;for(i=0;i<numBuses;i++){bus=that.buses[i];for(j=0;j<busLen;j++){bus[j]=0;}}
for(i=0;i<that.nodes.length;i++){node=that.nodes[i];node.gen(node.model.blockSize);}};};fluid.defaults("flock.autoEnviro",{gradeNames:["fluid.littleComponent","autoInit"]});flock.autoEnviro.preInit=function(that){if(!flock.enviro.shared){flock.init();}};fluid.defaults("flock.node",{gradeNames:["flock.autoEnviro","fluid.modelComponent","autoInit"]});fluid.defaults("flock.synth",{gradeNames:["flock.node","autoInit"],mergePolicy:{synthDef:"nomerge"},components:{ugens:{type:"flock.synth.ugenCache"}},rate:flock.rates.AUDIO});flock.synth.finalInit=function(that){that.rate=that.options.rate;that.enviro=that.enviro||flock.enviro.shared;that.model.blockSize=that.enviro.audioSettings.rates.control;that.gen=function(){var nodes=that.ugens.active,i,node;for(i=0;i<nodes.length;i++){node=nodes[i];node.gen(node.model.blockSize);}};that.get=function(path){return flock.input.get(that.ugens.named,path);};that.set=function(path,val,swap){return flock.input.set(that.ugens.named,path,val,undefined,function(ugenDef,path,target,previous){var ugen=flock.parse.ugenDef(ugenDef,{audioSettings:that.enviro.audioSettings,buses:that.enviro.buses,buffers:that.enviro.buffers});that.ugens.replace(ugen,previous,swap);return ugen;});};that.input=function(path,val,swap){return!path?undefined:typeof(path)==="string"?arguments.length<2?that.get(path):that.set(path,val,swap):flock.isIterable(path)?that.get(path):that.set(path,val,swap);};that.play=function(){var e=that.enviro;if(e.nodes.indexOf(that)===-1){e.head(that);}
if(!e.isPlaying){e.play();}};that.pause=function(){that.enviro.remove(that);};that.init=function(){if(!that.options.synthDef){fluid.log("Warning: Instantiating a flock.synth instance with an empty synth def.")}
that.out=flock.parse.synthDef(that.options.synthDef,{rate:that.options.rate,overrideRate:(that.options.rate===flock.rates.DEMAND),visitors:that.ugens.add,buffers:that.enviro.buffers,buses:that.enviro.buses,audioSettings:that.enviro.audioSettings});if(that.options.addToEnvironment!==false){that.enviro.tail(that);}};that.init();return that;};flock.synth.make=function(def,options){options=options||{};options.synthDef=def;return flock.synth(options);};fluid.defaults("flock.synth.ugenCache",{gradeNames:["fluid.littleComponent","autoInit"]});flock.synth.ugenCache.finalInit=function(that){that.named={};that.active=[];that.all=[];that.add=function(ugens){var i,ugen;ugens=fluid.makeArray(ugens);for(i=0;i<ugens.length;i++){ugen=ugens[i];that.all.push(ugen);if(ugen.gen){that.active.push(ugen);}
if(ugen.id){that.named[ugen.id]=ugen;}}};that.remove=function(ugens,recursively){var active=that.active,named=that.named,i,ugen,idx,inputs,input;ugens=fluid.makeArray(ugens);for(i=0;i<ugens.length;i++){ugen=ugens[i];idx=active.indexOf(ugen);if(idx>-1){active.splice(idx,1);}
if(ugen.id){delete named[ugen.id];}
if(recursively){inputs=[];for(input in ugen.inputs){inputs.push(ugen.inputs[input]);}
that.remove(inputs,true);}}};that.reattachInputs=function(currentUGen,previousUGen,inputsToReattach){var i,inputName;if(inputsToReattach){for(i=0;i<inputsToReattach.length;i++){inputName=inputsToReattach[i];currentUGen.inputs[inputName]=previousUGen.inputs[inputName];}}else{currentUGen.inputs=previousUGen.inputs;}};that.replaceActiveOutput=function(currentUGen,previousUGen){var i,ugen,inputName,input;for(i=0;i<that.active.length;i++){ugen=that.active[i];for(inputName in ugen.inputs){input=ugen.inputs[inputName];if(input===previousUGen){ugen.inputs[inputName]=currentUGen;break;}}}
return currentUGen;};that.swap=function(ugens,previousUGens,inputsToReattach){var i,prev,current;previousUGens=fluid.makeArray(previousUGens);ugens=fluid.makeArray(ugens);for(i=0;i<previousUGens.length;i++){prev=previousUGens[i];current=ugens[i];that.reattachInputs(current,prev,inputsToReattach);that.replaceActiveOutput(current,prev);}
return ugens;};that.replace=function(ugens,previousUGens,reattachInputs){if(reattachInputs){reattachInputs=typeof(reattachInputs)==="object"?reattachInputs:undefined;that.swap(ugens,previousUGens,reattachInputs);}
that.remove(previousUGens,true);that.add(ugens);return ugens;};return that;};fluid.defaults("flock.synth.group",{gradeNames:["flock.node","flock.nodeList","autoInit"],rate:flock.rates.AUDIO});flock.synth.group.finalInit=function(that){that.rate=that.options.rate;that.enviro=that.enviro||flock.enviro.shared;flock.synth.group.makeDispatchedMethods(that,["input","get","set","gen","play","pause"]);that.init=function(){if(that.options.addToEnvironment!==false){that.enviro.tail(that);}};that.init();};flock.synth.group.makeDispatcher=function(nodes,msg){return function(){var i,node,val;for(i=0;i<nodes.length;i++){node=nodes[i];val=node[msg].apply(node,arguments);}
return val;};};flock.synth.group.makeDispatchedMethods=function(that,methodNames){var name,i;for(i=0;i<methodNames.length;i++){name=methodNames[i];that[name]=flock.synth.group.makeDispatcher(that.nodes,name,flock.synth.group.dispatch);}
return that;};fluid.defaults("flock.synth.polyphonic",{gradeNames:["flock.synth.group","autoInit"],mergePolicy:{synthDef:"nomerge"},noteSpecs:{on:{"env.gate":1},off:{"env.gate":0}},maxVoices:16,initVoicesLazily:true,amplitudeKey:"env.sustain",amplitudeNormalizer:"static"});flock.synth.polyphonic.finalInit=function(that){that.activeVoices={};that.freeVoices=[];that.noteChange=function(voice,eventName,changeSpec){var noteEventSpec=that.options.noteSpecs[eventName];changeSpec=$.extend({},noteEventSpec,changeSpec);voice.input(changeSpec);};that.noteOn=function(noteName,changeSpec){var voice=that.nextFreeVoice();if(that.activeVoices[noteName]){that.noteOff(noteName);}
that.activeVoices[noteName]=voice;that.noteChange(voice,"on",changeSpec);return voice;};that.noteOff=function(noteName,changeSpec){var voice=that.activeVoices[noteName];if(!voice){return null;}
that.noteChange(voice,"off",changeSpec);delete that.activeVoices[noteName];that.freeVoices.push(voice);return voice;};that.createVoice=function(){var voice=flock.synth({synthDef:that.options.synthDef,addToEnvironment:false});var normalizer=that.options.amplitudeNormalizer,ampKey=that.options.amplitudeKey,normValue;if(normalizer){if(typeof(normalizer)==="function"){norm(voice,ampKey);}else if(normalizer==="static"){normValue=1.0/that.options.maxVoices;voice.input(ampKey,normValue);}}
that.nodes.push(voice);return voice;};that.pooledVoiceAllocator=function(){return that.freeVoices.pop();};that.lazyVoiceAllocator=function(){return that.freeVoices.length>1?that.freeVoices.pop():Object.keys(that.activeVoices).length>that.options.maxVoices?null:that.createVoice();};that.init=function(){if(!that.options.initVoicesLazily){for(var i=0;i<that.options.maxVoices;i++){that.freeVoices[i]=that.createVoice();}
that.nextFreeVoice=that.pooledVoiceAllocator;}else{that.nextFreeVoice=that.lazyVoiceAllocator;}};that.init();return that;};fluid.isPrimitive=function(value){var valueType=typeof(value);return!value||valueType==="string"||valueType==="boolean"||valueType==="number"||valueType==="function"||value instanceof Float32Array;};}());
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";flock.shim={URL:typeof(window)!=="undefined"?window.URL||window.webkitURL||window.msURL:undefined};flock.worker=function(code){var type=typeof(code),url,blob;if(type==="function"){code="("+code.toString()+")();";}else if(type!=="string"){throw new Error("A flock.worker must be initialized with a String or a Function.");}
if(window.Blob){blob=new Blob([code],{type:"text/javascript"});url=flock.shim.URL.createObjectURL(blob);}else{url="data:text/javascript;base64,"+window.btoa(code);}
return new Worker(url);};fluid.registerNamespace("flock.scheduler");fluid.defaults("flock.scheduler.intervalClock",{gradeNames:["fluid.eventedComponent","autoInit"],events:{tick:null}});flock.scheduler.intervalClock.finalInit=function(that){that.scheduled={};that.schedule=function(interval){var id=setInterval(function(){that.events.tick.fire(interval);},interval);that.scheduled[interval]=id;};that.clear=function(interval){var id=that.scheduled[interval];clearInterval(id);delete that.scheduled[interval];};that.clearAll=function(){for(var interval in that.scheduled){that.clear(interval);}};that.end=that.clearAll;};fluid.defaults("flock.scheduler.scheduleClock",{gradeNames:["fluid.eventedComponent","autoInit"],events:{tick:null}});flock.scheduler.scheduleClock.finalInit=function(that){that.scheduled=[];that.schedule=function(timeFromNow){var id;id=setTimeout(function(){that.clear(id);that.events.tick.fire(timeFromNow);},timeFromNow);that.scheduled.push(id);};that.clear=function(id,idx){idx=idx===undefined?that.scheduled.indexOf(id):idx;if(idx>-1){that.scheduled.splice(idx,1);}
clearTimeout(id);};that.clearAll=function(){for(var i=0;i<that.scheduled.length;i++){var id=that.scheduled[i];clearTimeout(id);}
that.scheduled.length=0;};that.end=that.clearAll;};fluid.defaults("flock.scheduler.webWorkerClock",{gradeNames:["fluid.modelComponent","fluid.eventedComponent","autoInit"],model:{messages:{schedule:{msg:"schedule"},clear:{msg:"clear"},clearAll:{msg:"clearAll"},end:{msg:"end"}}},events:{tick:null},clockType:"intervalClock"});flock.scheduler.webWorkerClock.finalInit=function(that){that.worker=new flock.worker(flock.scheduler.webWorkerClock.workerImpl);that.worker.postMessage({msg:"start",value:that.options.clockType});that.worker.addEventListener("message",function(e){that.events.tick.fire(e.data.value);},false);that.postToWorker=function(msgName,value){var msg=that.model.messages[msgName];if(value!==undefined){msg.value=value;}
that.worker.postMessage(msg);};that.schedule=function(time){that.postToWorker("schedule",time);};that.clear=function(time){that.postToWorker("clear",time);};that.clearAll=function(){that.postToWorker("clearAll");};that.end=function(){that.postToWorker("end");};};flock.scheduler.webWorkerClock.workerImpl=function(){"use strict";var flock=flock||{};flock.worker=flock.worker||{};flock.worker.clock=function(){var that={};that.tick=function(interval){self.postMessage({msg:"tick",value:interval});};return that;};flock.worker.intervalClock=function(){var that=flock.worker.clock();that.scheduled={};that.schedule=function(interval){var id=setInterval(function(){that.tick(interval);},interval);that.scheduled[interval]=id;};that.clear=function(interval){var id=that.scheduled[interval];clearInterval(id);delete that.scheduled[interval];};that.clearAll=function(){for(var interval in that.scheduled){that.clear(interval);}};return that;};flock.worker.scheduleClock=function(){var that=flock.worker.clock();that.scheduled=[];that.schedule=function(timeFromNow){var id;id=setTimeout(function(){that.clear(id);that.tick(timeFromNow);},timeFromNow);that.scheduled.push(id);};that.clear=function(id,idx){idx=idx===undefined?that.scheduled.indexOf(id):idx;if(idx>-1){that.scheduled.splice(idx,1);}
clearTimeout(id);};that.clearAll=function(){for(var i=0;i<that.scheduled.length;i++){var id=that.scheduled[i];clearTimeout(id);}
that.scheduled.length=0;};return that;};self.addEventListener("message",function(e){if(e.data.msg==="start"){flock.clock=flock.worker[e.data.value]();}else if(e.data.msg==="end"){if(flock.clock){flock.clock.clearAll();self.close();}}else if(flock.clock){flock.clock[e.data.msg](e.data.value);}},false);};fluid.defaults("flock.scheduler.webWorkerIntervalClock",{gradeNames:["flock.scheduler.webWorkerClock","autoInit"],clockType:"intervalClock"});fluid.defaults("flock.scheduler.webWorkerScheduleClock",{gradeNames:["flock.scheduler.webWorkerClock","autoInit"],clockType:"scheduleClock"});flock.scheduler.makeOneShotValueListener=function(value,fn,removeFn){var listener=function(time){if(time===value){fn(time);removeFn(listener);}};return listener;};flock.scheduler.makeRepeatingValueListener=function(value,fn){return function(time){if(time===value){fn(time);}};};fluid.defaults("flock.scheduler.async",{gradeNames:["fluid.littleComponent","autoInit"],components:{timeConverter:{type:"flock.convert.seconds"},intervalClock:{type:"flock.scheduler.webWorkerIntervalClock"},scheduleClock:{type:"flock.scheduler.webWorkerScheduleClock"}}});flock.scheduler.async.finalInit=function(that){that.intervalListeners={};that.scheduleListeners=[];that.addIntervalListener=function(interval,fn){var listener=flock.scheduler.makeRepeatingValueListener(interval,fn);listener.wrappedListener=fn;that.intervalListeners[interval]=that.intervalListeners[interval]||[];that.intervalListeners[interval].push(listener);that.intervalClock.events.tick.addListener(listener);return listener;};that.addScheduleListener=function(time,fn){var listener=flock.scheduler.makeOneShotValueListener(time,fn,that.clear);listener.wrappedListener=fn;that.scheduleListeners.push(listener);that.scheduleClock.events.tick.addListener(listener);return listener;};that.repeat=function(interval,changeSpec){var ms=that.timeConverter.value(interval),fn=typeof(changeSpec)==="function"?changeSpec:flock.scheduler.async.evaluateChangeSpec(changeSpec),listener=that.addIntervalListener(ms,fn);that.intervalClock.schedule(ms);return listener;};that.once=function(time,changeSpec){var ms=that.timeConverter.value(time),fn=typeof(changeSpec)==="function"?changeSpec:flock.scheduler.async.evaluateChangeSpec(changeSpec),listener=that.addScheduleListener(ms,fn);that.scheduleClock.schedule(ms);return listener;};that.sequence=function(times,changeSpec){var listeners=[],listener;for(var i=0;i<times.length;i++){listener=that.once(times[i],changeSpec);listeners.push(listener);}
return listeners;};that.schedule=function(schedules){var i,schedule;for(i=0;i<schedules.length;i++){schedule=schedules[i];flock.invoke(that,schedule.interval,[schedule.time,schedule.change]);}};that.clear=function(listener){if(!listener){return;}
var idx=that.scheduleListeners.indexOf(listener),interval;if(idx>-1){that.scheduleClock.events.tick.removeListener(listener);that.scheduleListeners.splice(idx,1);return;}
that.intervalClock.events.tick.removeListener(listener);for(interval in that.intervalListeners){idx=that.intervalListeners[interval].indexOf(listener);if(idx>-1){that.intervalListeners[interval].splice(idx,1);}}};that.clearRepeat=function(interval){that.intervalClock.clear(interval);var listeners=that.intervalListeners[interval],i,listener;if(!listeners){return;}
for(i=0;i<listeners.length;i++){listener=listeners[i];that.intervalClock.events.tick.removeListener(listener);}
listeners.length=0;return listener;};that.clearAll=function(){that.intervalClock.clearAll();for(var interval in that.intervalListeners){that.clearRepeat(interval);}
that.scheduleClock.clearAll();for(var listener in that.scheduleListeners){that.clear(listener);}};that.end=function(){that.intervalClock.end();that.scheduleClock.end();};};flock.scheduler.async.evaluateChangeSpec=function(changeSpec){var synths={},staticChanges={};for(var path in changeSpec.values){var change=changeSpec.values[path];if(change.synthDef){change.addToEnvironment=false;change.rate=flock.rates.DEMAND;synths[path]=flock.synth(change);}else{staticChanges[path]=change;}}
return function(){for(var path in synths){var synth=synths[path];synth.gen(1);var ugens=synth.ugens.all;staticChanges[path]=ugens[ugens.length-1].output[0];}
var targetSynth=typeof(changeSpec.synth)==="string"?flock.enviro.shared.namedNodes[changeSpec.synth]:changeSpec.synth;targetSynth.set(staticChanges);};};flock.scheduler.async.beat=function(bpm,options){var that=fluid.initComponent("flock.scheduler.async.beat",options);if(bpm!==undefined){that.timeConverter.options.bpm=bpm;}
return that;};fluid.defaults("flock.scheduler.async.beat",{gradeNames:["flock.scheduler.async"],argumentMap:{options:1},components:{timeConverter:{type:"flock.convert.beats",options:{bpm:60}}}});fluid.registerNamespace("flock.convert");flock.convert.makeStatelessConverter=function(convertFn){return function(options){return{value:convertFn};}};flock.convert.ms=flock.convert.makeStatelessConverter(fluid.identity);flock.convert.seconds=flock.convert.makeStatelessConverter(function(secs){return secs*1000;});fluid.defaults("flock.convert.beats",{gradeNames:["fluid.littleComponent","autoInit"],bpm:60});flock.convert.beats.finalInit=function(that){that.value=function(beats){var bpm=that.options.bpm;return bpm<=0?0:(beats/bpm)*60000;};};}());
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";fluid.defaults("flock.enviro.moz",{gradeNames:["flock.enviro.audioStrategy","autoInit"],components:{genScheduler:{type:"flock.scheduler.async",options:{components:{timeConverter:{type:"flock.convert.ms"}}}}}});flock.enviro.moz.finalInit=function(that){that.startGeneratingSamples=function(){if(that.scheduled){return;}
if(flock.platform.isLinuxBased&&that.audioEl.mozCurrentSampleOffset()===0){that.prebufferSilence();}
that.genScheduler.repeat(that.model.queuePollInterval,that.writeSamples);that.scheduled=true;};that.prebufferSilence=function(){while(that.audioEl.mozCurrentSampleOffset()===0){that.audioEl.mozWriteAudio(that.silentBuffer);}};that.writeSamples=function(){var playState=that.model.playState,currentOffset=that.audioEl.mozCurrentSampleOffset(),queued=playState.written-currentOffset,outBuf=that.outBuffer,audioSettings=that.options.audioSettings;if(queued>audioSettings.bufferSize||that.nodeEvaluator.nodes.length<1){return;}
flock.enviro.moz.interleavedWriter(outBuf,that.nodeEvaluator.gen,that.nodeEvaluator.buses,that.model.krPeriods,audioSettings.rates.control,audioSettings.chans);playState.written+=that.audioEl.mozWriteAudio(outBuf);if(playState.written>=playState.total){that.stop();}};that.stopGeneratingSamples=function(){that.genScheduler.clearRepeat(that.model.writeInterval);that.scheduled=false;};that.init=function(){var audioSettings=that.options.audioSettings,rates=audioSettings.rates,bufSize=audioSettings.bufferSize,chans=audioSettings.chans,numSamps=bufSize*chans;that.outBuffer=new Float32Array(numSamps);that.silentBuffer=new Float32Array(numSamps);that.audioEl=new Audio();that.audioEl.mozSetup(chans,rates.audio);that.model.bufferDur=(bufSize/rates.audio)*1000;that.model.queuePollInterval=Math.ceil(that.model.bufferDur/audioSettings.genPollIntervalFactor);that.model.krPeriods=bufSize/rates.control;};that.init();};flock.enviro.moz.interleavedWriter=function(outBuf,evalFn,sourceBufs,krPeriods,kr,chans){for(var i=0;i<krPeriods;i++){evalFn();var offset=i*kr*chans;for(var chan=0;chan<chans;chan++){var sourceBuf=sourceBufs[chan];for(var sampIdx=0;sampIdx<kr;sampIdx++){var frameIdx=sampIdx*chans+offset;outBuf[frameIdx+chan]=sourceBuf[sampIdx];}}}
return outBuf;};fluid.demands("flock.enviro.audioStrategy","flock.platform.moz",{funcName:"flock.enviro.moz"});}());
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";fluid.defaults("flock.enviro.webAudio",{gradeNames:["flock.enviro.audioStrategy","autoInit"]});flock.enviro.webAudio.finalInit=function(that){that.startGeneratingSamples=function(){that.jsNode.onaudioprocess=that.writeSamples;that.jsNode.connect(that.context.destination);};that.stopGeneratingSamples=function(){that.jsNode.disconnect(0);that.jsNode.onaudioprocess=undefined;};that.writeSamples=function(e){var audioSettings=that.options.audioSettings,kr=audioSettings.rates.control,playState=that.model.playState,chans=audioSettings.chans,outBufs=e.outputBuffer;if(that.nodeEvaluator.nodes.length<1){for(chan=0;chan<chans;chan++){flock.generate.silence(outBufs.getChannelData(chan));}
return;}
for(var i=0;i<that.model.krPeriods;i++){that.nodeEvaluator.gen();var offset=i*kr;for(var chan=0;chan<chans;chan++){var sourceBuf=that.nodeEvaluator.buses[chan],outBuf=outBufs.getChannelData(chan);for(var samp=0;samp<kr;samp++){outBuf[samp+offset]=sourceBuf[samp];}}}
playState.written+=audioSettings.bufferSize*chans;if(playState.written>=playState.total){that.stop();}};that.init=function(){var settings=that.options.audioSettings;that.model.krPeriods=settings.bufferSize/settings.rates.control;if(!flock.enviro.webAudio.audioContext){flock.enviro.webAudio.audioContext=new flock.enviro.webAudio.contextConstructor();}
that.context=flock.enviro.webAudio.audioContext;settings.rates.audio=that.context.sampleRate;that.source=that.context.createBufferSource();that.jsNode=that.context.createJavaScriptNode(settings.bufferSize);that.source.connect(that.jsNode);};that.init();};flock.enviro.webAudio.contextConstructor=window.AudioContext||window.webkitAudioContext;fluid.demands("flock.enviro.audioStrategy","flock.platform.webAudio",{funcName:"flock.enviro.webAudio"});}());
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";var $=fluid.registerNamespace("jQuery");fluid.registerNamespace("flock.parse");flock.parse.synthDef=function(ugenDef,options){if(!ugenDef){ugenDef=[];}
if(options.rate===flock.rates.AUDIO&&(typeof(ugenDef.length)==="number"||(ugenDef.id!==flock.OUT_UGEN_ID&&ugenDef.ugen!=="flock.ugen.out"))){ugenDef={id:flock.OUT_UGEN_ID,ugen:"flock.ugen.out",inputs:{sources:ugenDef,bus:0,expand:options.audioSettings.chans}};}
return flock.parse.ugenForDef(ugenDef,options);};flock.parse.makeUGen=function(ugenDef,parsedInputs,options){var rates=options.audioSettings.rates;if(!ugenDef.rate){ugenDef.rate=flock.rates.AUDIO;}
var buffer=new Float32Array(ugenDef.rate===flock.rates.AUDIO?rates.control:1),sampleRate;if(ugenDef.options&&ugenDef.options.sampleRate!==undefined){sampleRate=ugenDef.options.sampleRate;}else if(ugenDef.rate===flock.rates.AUDIO){sampleRate=rates.audio;}else if(ugenDef.rate===flock.rates.CONTROL){sampleRate=rates.audio/rates.control;}else{sampleRate=1;}
ugenDef.options=$.extend(true,{},ugenDef.options,{sampleRate:sampleRate,rate:ugenDef.rate,audioSettings:{rates:rates}});ugenDef.options.audioSettings.buffers=options.buffers;ugenDef.options.audioSettings.buses=options.buses;return flock.invoke(undefined,ugenDef.ugen,[parsedInputs,buffer,ugenDef.options]);};flock.parse.reservedWords=["id","ugen","rate","inputs","options"];flock.parse.specialInputs=["value","buffer","table"];flock.parse.expandUGenDef=function(ugenDef){var inputs={},prop;for(prop in ugenDef){if(flock.parse.reservedWords.indexOf(prop)===-1){inputs[prop]=ugenDef[prop];delete ugenDef[prop];}}
ugenDef.inputs=inputs;return ugenDef;};flock.parse.expandValueDef=function(ugenDef){var type=typeof(ugenDef);if(type==="number"){return{ugen:"flock.ugen.value",rate:flock.rates.CONSTANT,inputs:{value:ugenDef}};}
if(type==="object"){return ugenDef;}
throw new Error("Invalid value type found in ugen definition.");};flock.parse.rateMap={"ar":flock.rates.AUDIO,"kr":flock.rates.CONTROL,"dr":flock.rates.DEMAND,"cr":flock.rates.CONSTANT};flock.parse.expandRate=function(ugenDef,options){ugenDef.rate=options.overrideRate?options.rate:flock.parse.rateMap[ugenDef.rate]||ugenDef.rate;return ugenDef;};flock.parse.ugenDef=function(ugenDefs,options){var parseFn=flock.isIterable(ugenDefs)?flock.parse.ugensForDefs:flock.parse.ugenForDef;var parsed=parseFn(ugenDefs,options);return parsed;};flock.parse.ugensForDefs=function(ugenDefs,options){var parsed=[],i;for(i=0;i<ugenDefs.length;i++){parsed[i]=flock.parse.ugenForDef(ugenDefs[i],options);}
return parsed;};flock.parse.ugenForDef=function(ugenDef,options){options=$.extend(true,{audioSettings:flock.enviro.shared.options.audioSettings,buses:flock.enviro.shared.buses,buffers:flock.enviro.shared.buffers},options);var o=options,visitors=o.visitors,rates=o.audioSettings.rates;ugenDef=flock.parse.expandValueDef(ugenDef);if(flock.isIterable(ugenDef)){return flock.parse.ugensForDefs(ugenDef,options);}
if(!ugenDef.inputs){ugenDef=flock.parse.expandUGenDef(ugenDef);}
flock.parse.expandRate(ugenDef,options);var defaults=fluid.defaults(ugenDef.ugen)||{};defaults=fluid.copy(defaults);defaults.options=defaults.ugenOptions;delete defaults.ugenOptions;ugenDef=$.extend(true,{},defaults,ugenDef);var inputDefs=ugenDef.inputs,inputs={},inputDef;for(inputDef in inputDefs){inputs[inputDef]=flock.parse.specialInputs.indexOf(inputDef)>-1?ugenDef.inputs[inputDef]:flock.parse.ugenForDef(ugenDef.inputs[inputDef],options);}
if(!ugenDef.ugen){throw new Error("Unit generator definition lacks a 'ugen' property; can't initialize the synth graph.");}
var ugen=flock.parse.makeUGen(ugenDef,inputs,options);ugen.id=ugenDef.id;if(visitors){visitors=fluid.makeArray(visitors);fluid.each(visitors,function(visitor){visitor(ugen,ugenDef,rates);});}
return ugen;};flock.parse.bufferForDef=function(bufDef,onLoad,enviro){enviro=enviro||flock.enviro.shared;var id=bufDef.id||fluid.allocateGuid(),src;if(bufDef.url){src=bufDef.url;}else if(bufDef.selector){src=document.querySelector(bufDef.selector).files[0];}
enviro.loadBuffer(id,src,onLoad);};}());
var fluid=fluid||require("infusion"),flock=fluid.registerNamespace("flock");(function(){"use strict";var $=fluid.registerNamespace("jQuery");flock.aliasUGen=function(sourcePath,aliasName,inputDefaults,defaultOptions){var root=flock.get(sourcePath);flock.set(root,aliasName,function(inputs,output,options){options=$.extend(true,{},defaultOptions,options);return root(inputs,output,options);});fluid.defaults(sourcePath+"."+aliasName,inputDefaults);};flock.aliasUGens=function(sourcePath,aliasesSpec){var aliasName,settings;for(aliasName in aliasesSpec){settings=aliasesSpec[aliasName];flock.aliasUGen(sourcePath,aliasName,{inputs:settings.inputDefaults},settings.options);}};flock.krMul=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul;}};flock.mul=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i];}};flock.krAdd=function(numSamps,output,mulInput,addInput){var add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]+add;}};flock.add=function(numSamps,output,mulInput,addInput){var add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]+add[i];}};flock.krMulAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul+add[i];}};flock.mulKrAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i]+add;}};flock.krMulKrAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul+add;}};flock.mulAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i]+add[i];}};flock.onMulAddInputChanged=function(that){var mul=that.inputs.mul,add=that.inputs.add,fn;if(!mul&&!add){that.mulAdd=fluid.identity;return;}
if(!mul){fn=add.rate!==flock.rates.AUDIO?flock.krAdd:flock.add;}else if(!add){fn=mul.rate!==flock.rates.AUDIO?flock.krMul:flock.mul;}else{fn=mul.rate!==flock.rates.AUDIO?(add.rate!==flock.rates.AUDIO?flock.krMulKrAdd:flock.krMulAdd):(add.rate!==flock.rates.AUDIO?flock.mulKrAdd:flock.mulAdd);}
that.mulAdd=function(numSamps){fn(numSamps,that.output,mul,add);};};flock.ugen=function(inputs,output,options){options=options||{};var that={rate:options.rate||flock.rates.AUDIO,inputs:inputs,output:output,options:options,model:options.model||{}};that.options.audioSettings=that.options.audioSettings||flock.enviro.shared.audioSettings;that.model.sampleRate=options.sampleRate||that.options.audioSettings.rates[that.rate];that.model.blockSize=that.rate===flock.rates.AUDIO?that.options.audioSettings.rates.control:1;that.model.sampleDur=1.0/that.model.sampleRate;that.get=function(path){return flock.input.get(that.inputs,path);};that.set=function(path,val,swap){return flock.input.set(that.inputs,path,val,that,function(ugenDef){if(ugenDef===null){return undefined;}
return flock.parse.ugenDef(ugenDef,{audioSettings:that.options.audioSettings,buses:that.options.audioSettings.buses,buffers:that.options.audioSettings.buffers});});};that.input=function(path,val){return!path?undefined:typeof(path)==="string"?arguments.length<2?that.get(path):that.set(path,val):flock.isIterable(path)?that.get(path):that.set(path,val);};that.calculateStrides=function(){var m=that.model,strideNames=that.options.strideInputs,inputs=that.inputs,i,name;m.strides=m.strides||{};for(i=0;i<strideNames.length;i++){name=strideNames[i];m.strides[name]=inputs[name].rate===flock.rates.AUDIO?1:0;}};that.onInputChanged=fluid.identity;that.interpolate=flock.interpolate[that.options.interpolation];if(that.rate===flock.rates.DEMAND&&that.inputs.freq){that.inputs.freq=flock.parse.ugenDef({ugen:"flock.ugen.value",value:1.0});}
return that;};flock.ugen.value=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.output[0]=that.model.value=inputs.value;return that;};fluid.defaults("flock.ugen.value",{rate:"constant"});flock.ugen.math=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.expandedSource=new Float32Array(that.options.audioSettings.rates.control);that.krSourceKrInputGen=function(){var op=that.activeInput,input=that.inputs[op],sourceBuf=flock.generate(that.expandedSource,that.inputs.source.output[0]);DSP[op](that.output,sourceBuf,input.output[0]);};that.krSourceArInputGen=function(){var op=that.activeInput,input=that.inputs[op],sourceBuf=flock.generate(that.expandedSource,that.inputs.source.output[0]);DSP[op](that.output,sourceBuf,input.output);};that.arSourceKrInputGen=function(){var op=that.activeInput,input=that.inputs[op],sourceBuf=that.inputs.source.output;DSP[op](that.output,sourceBuf,input.output[0]);};that.arSourceArInputGen=function(){var op=that.activeInput,input=that.inputs[op];DSP[op](that.output,that.inputs.source.output,input.output);};that.onInputChanged=function(){var inputs=Object.keys(that.inputs),i,input,isInputAudioRate;for(i=0;i<inputs.length;i++){input=inputs[i];if(input!=="source"){that.activeInput=input;isInputAudioRate=that.inputs[input].rate==="audio";that.gen=that.inputs.source.rate==="audio"?(isInputAudioRate?that.arSourceArInputGen:that.arSourceKrInputGen):(isInputAudioRate?that.krSourceArInputGen:that.krSourceKrInputGen);break;}}};that.init=function(){if(typeof(DSP)==="undefined"){throw new Error("DSP is undefined. Please include dspapi.js to use the flock.math unit generator.");}
that.onInputChanged();};that.init();return that;};flock.ugen.sum=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.sumGen=function(numSamps){var sources=that.inputs.sources,out=that.output,i,sourceIdx,sum;for(i=0;i<numSamps;i++){sum=0;for(sourceIdx=0;sourceIdx<sources.length;sourceIdx++){sum+=sources[sourceIdx].output[i];}
out[i]=sum;}};that.onInputChanged=function(){if(typeof(that.inputs.sources.length)==="number"){that.gen=that.sumGen;}else{that.output=that.inputs.sources.output;that.gen=fluid.identity;}};that.onInputChanged();return that;};fluid.defaults("flock.ugen.sum",{rate:"audio"});flock.ugen.osc=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.phase=0.0;that.gen=function(numSamps){var m=that.model,inputs=that.inputs,freq=inputs.freq.output,phaseOffset=inputs.phase.output,table=inputs.table,tableLen=m.tableLen,tableIncHz=m.tableIncHz,tableIncRad=m.tableIncRad,output=that.output,phase=m.phase,i,j,k,idx;for(i=0,j=0,k=0;i<numSamps;i++,j+=m.strides.phase,k+=m.strides.freq){idx=phase+phaseOffset[j]*tableIncRad;if(idx>=tableLen){idx-=tableLen;}else if(idx<0){idx+=tableLen;}
output[i]=that.interpolate?that.interpolate(idx,table):table[idx|0];phase+=freq[k]*tableIncHz;if(phase>=tableLen){phase-=tableLen;}else if(phase<0){phase+=tableLen;}}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.ugen.osc.onInputChanged(that);var m=that.model;m.tableLen=that.inputs.table.length;m.tableIncHz=m.tableLen/m.sampleRate;m.tableIncRad=m.tableLen/flock.TWOPI;};that.onInputChanged();return that;};flock.ugen.osc.onInputChanged=function(that){that.calculateStrides();flock.onMulAddInputChanged(that);};fluid.defaults("flock.ugen.osc",{rate:"audio",inputs:{freq:440.0,phase:0.0},ugenOptions:{strideInputs:["freq","phase"]},tableSize:8192});flock.ugen.osc.define=function(name,tableFillFn){var lastSegIdx=name.lastIndexOf("."),namespace=name.substring(0,lastSegIdx),oscName=name.substring(lastSegIdx+1),namespaceObj=flock.get(namespace);namespaceObj[oscName]=function(inputs,output,options){var defaults=fluid.defaults("flock.ugen.osc"),merged=fluid.merge(null,defaults,options),s=merged.tableSize;inputs.table=tableFillFn(s,flock.TWOPI/s);return flock.ugen.osc(inputs,output,options);};fluid.defaults(name,fluid.defaults("flock.ugen.osc"));};flock.ugen.osc.define("flock.ugen.sinOsc",function(size,scale){return flock.generate(size,function(i){return Math.sin(i*scale);});});flock.ugen.osc.fourierTable=function(size,scale,numHarms,phase,amps){phase*=flock.TWOPI;return flock.generate(size,function(i){var harm,amp,w,val=0.0;for(harm=0;harm<numHarms;harm++){amp=amps?amps[harm]:1.0;w=(harm+1)*(i*scale);val+=amp*Math.cos(w+phase);}
return val;});};flock.ugen.osc.normalizedFourierTable=function(size,scale,numHarms,phase,ampGenFn){var amps=flock.generate(numHarms,function(harm){return ampGenFn(harm+1);});var table=flock.ugen.osc.fourierTable(size,scale,numHarms,phase,amps);return flock.normalize(table);};flock.ugen.osc.define("flock.ugen.triOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,1000,1.0,function(harm){return harm%2===0?0.0:1.0/(harm*harm);});});flock.ugen.osc.define("flock.ugen.sawOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,10,-0.25,function(harm){return 1.0/harm;});});flock.ugen.osc.define("flock.ugen.squareOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,10,-0.25,function(harm){return harm%2===0?0.0:1.0/harm;});});flock.ugen.sin=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.phase=0.0;that.gen=function(numSamps){var m=that.model,freq=that.inputs.freq.output,phaseOffset=that.inputs.phase.output,out=that.output,phase=m.phase,sampleRate=m.sampleRate,i,j,k;for(i=0,j=0,k=0;i<numSamps;i++,j+=m.strides.phase,k+=m.strides.freq){out[i]=Math.sin(phase+phaseOffset[j]);phase+=freq[k]/sampleRate*flock.TWOPI;}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.ugen.osc.onInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.sin",fluid.defaults("flock.ugen.osc"));flock.ugen.lfSaw=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.scale=2*(1/options.sampleRate);that.gen=function(numSamps){var m=that.model,freq=that.inputs.freq.output,out=that.output,scale=m.scale,phaseOffset=that.inputs.phase.output[0],phase=m.phase,i,j;for(i=0,j=0;i<numSamps;i++,j+=m.strides.freq){out[i]=phase+phaseOffset;phase+=freq[j]*scale;if(phase>=1.0){phase-=2.0;}else if(phase<=-1.0){phase+=2.0;}}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){var m=that.model;m.freqInc=that.inputs.freq.rate===flock.rates.AUDIO?1:0;m.phase=0.0;that.calculateStrides();flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.lfSaw",{rate:"audio",inputs:{phase:0.0},ugenOptions:{strideInputs:["freq"]}});flock.ugen.lfPulse=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.scale=1/options.sampleRate;that.gen=function(numSamps){var inputs=that.inputs,m=that.model,freq=inputs.freq.output,freqInc=m.freqInc,width=inputs.width.output[0],out=that.output,scale=m.scale,phase=m.phase!==undefined?m.phase:inputs.phase.output[0],i,j;for(i=0,j=0;i<numSamps;i++,j+=freqInc){if(phase>=1.0){phase-=1.0;out[i]=width<0.5?1.0:-1.0;}else{out[i]=phase<width?1.0:-1.0;}
phase+=freq[j]*scale;}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){that.model.freqInc=that.inputs.freq.rate===flock.rates.AUDIO?1:0;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.lfPulse",{rate:"audio",inputs:{phase:0.0,width:0.5}});flock.ugen.impulse=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var inputs=that.inputs,m=that.model,out=that.output,freq=inputs.freq.output,freqInc=m.strides.freq,phaseOffset=inputs.phase.output[0],phase=m.phase,scale=m.scale,i,j,val;phase+=phaseOffset;for(i=0,j=0;i<numSamps;i++,j+=freqInc){if(phase>=1.0){phase-=1.0;val=1.0;}else{val=0.0;}
out[i]=val;phase+=freq[j]*scale;}
m.phase=phase-phaseOffset;that.mulAdd(numSamps);};that.onInputChanged=function(){that.model.phase=0.0;that.calculateStrides();flock.onMulAddInputChanged(that);};that.init=function(){that.model.scale=1.0/that.model.sampleRate;that.onInputChanged();};that.init();return that;};fluid.defaults("flock.ugen.impulse",{rate:"audio",inputs:{freq:440,phase:0.0},ugenOptions:{strideInputs:["freq"]}});flock.buffer={listeners:{},addListener:function(id,ugen){if(!ugen.onBufferReady){return;}
var listeners=flock.buffer.listeners[id];if(!listeners){listeners=flock.buffer.listeners[id]=[];}
listeners.push(ugen);},fireOnce:function(id,channelBuffer,buffer){var listeners=flock.buffer.listeners[id],i,ugen;if(!listeners||!buffer){return;}
for(i=0;i<listeners.length;i++){ugen=listeners[i];ugen.onBufferReady(channelBuffer,id,buffer);}
flock.buffer.listeners[name]=[];}};flock.buffer.fireReady=function(ugen,id,buffer,name,chan){ugen.buffer=buffer?buffer[chan]:ugen.buffer;ugen.model.name=name;flock.buffer.fireOnce(id,ugen.buffer,buffer);};flock.buffer.resolveBufferId=function(ugen,id,chan){var buffer=ugen.options.audioSettings.buffers[id];flock.buffer.addListener(id,ugen);if(buffer){flock.buffer.fireReady(ugen,id,buffer,id,chan);}};flock.buffer.resolveBufferArray=function(ugen,buffer,chan){var id=fluid.allocateGuid();flock.buffer.addListener(id,ugen);flock.buffer.fireReady(ugen,id,[buffer],id,chan);};flock.buffer.resolveBufferDef=function(ugen,bufDef,chan){flock.buffer.addListener(bufDef.id,ugen);flock.parse.bufferForDef(bufDef,function(buffer,name){flock.buffer.fireReady(ugen,bufDef.id,buffer,name,chan)});};flock.buffer.resolveBuffer=function(ugen){var m=ugen.model,inputs=ugen.inputs,bufDef=m.bufDef=inputs.buffer,chan=inputs.channel?inputs.channel.output[0]:0,buf;if(!bufDef){return;}else if(typeof(bufDef)==="string"){flock.buffer.resolveBufferId(ugen,bufDef,chan);}else if(flock.isIterable(bufDef)){flock.buffer.resolveBufferArray(ugen,bufDef,chan);}else{flock.buffer.resolveBufferDef(ugen,bufDef,chan);}};flock.ugen.playBuffer=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.buffer=new Float32Array(that.output.length);that.crRegularSpeedGen=function(numSamps){var m=that.model,out=that.output,chan=that.inputs.channel.output[0],source=that.buffer,bufIdx=m.idx,bufLen=source.length,loop=that.inputs.loop.output[0],i;if(m.channel!==chan){m.channel=chan;that.buffer=source=that.options.audioSettings.buffers[m.name][chan];}
for(i=0;i<numSamps;i++){if(bufIdx>=bufLen){if(loop>0){bufIdx=0;}else{out[i]=0.0;continue;}}
out[i]=source[bufIdx];bufIdx++;}
m.idx=bufIdx;};that.krSpeedGen=function(numSamps){var m=that.model,out=that.output,chan=that.inputs.channel.output[0],speedInc=that.inputs.speed.output[0],source=that.buffer,bufIdx=m.idx,bufLen=source.length,loop=that.inputs.loop.output[0],i;if(m.channel!==chan){m.channel=chan;that.buffer=source=that.options.audioSettings.buffers[m.name][chan];}
for(i=0;i<numSamps;i++){if(bufIdx>=bufLen){if(loop>0){bufIdx=0;}else{out[i]=0.0;continue;}}
out[i]=source[Math.round(bufIdx)];bufIdx+=speedInc;}
m.idx=bufIdx;};that.onBufferReady=function(){that.model.idx=0;};that.onInputChanged=function(inputName){var m=that.model,inputs=that.inputs;if(m.bufDef!==that.inputs.buffer||inputName==="buffer"){flock.buffer.resolveBuffer(that);}
that.gen=(inputs.speed.rate===flock.rates.CONSTANT&&inputs.speed.output[0]===1.0)?that.crRegularSpeedGen:that.krSpeedGen;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.playBuffer",{rate:"audio",inputs:{channel:0,loop:0.0,speed:1.0},ugenOptions:{model:{idx:0,channel:undefined}}});flock.ugen.bufferDuration=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.audioSampleRate=options.audioSettings.rates.audio;that.krGen=function(numSamps){var m=that.model,i;for(i=0;i<numSamps;i++){that.output[i]=m.value=that.buffer.length/m.audioSampleRate;}};that.onInputChanged=function(inputName){if(that.model.bufDef!==that.inputs.buffer||inputName==="buffer"){flock.buffer.resolveBuffer(that);}};that.onBufferReady=function(buffer){that.output[0]=that.model.value=buffer.length/that.model.audioSampleRate;};that.init=function(){var r=that.rate;that.gen=(r===flock.rates.CONTROL||r===flock.rates.AUDIO)?that.krGen:undefined;that.output[0]=that.model.value=0.0;that.onInputChanged();};that.init();return that;};fluid.defaults("flock.ugen.bufferDuration",{rate:"constant",inputs:{channel:0}});flock.ugen.sampleRate=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.output[0]=that.model.sampleRate;return that;};fluid.defaults("flock.ugen.sampleRate",{rate:"constant",inputs:{}});flock.ugen.dust=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.density=0.0;that.model.scale=0.0;that.model.threshold=0.0;that.gen=function(numSamps){var m=that.model,density=inputs.density.output[0],threshold,scale,val,i;if(density!==m.density){m.density=density;threshold=m.threshold=density*m.sampleDur;scale=m.scale=threshold>0.0?1.0/threshold:0.0;}else{threshold=m.threshold;scale=m.scale;}
for(i=0;i<numSamps;i++){val=Math.random();output[i]=(val<threshold)?val*scale:0.0;}
that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.dust",{rate:"audio",inputs:{density:1.0}});flock.ugen.whiteNoise=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var out=that.output,i;for(i=0;i<numSamps;i++){out[i]=Math.random();}
that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.whiteNoise",{rate:"audio"});flock.ugen.lfNoise=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.counter=0;that.model.level=0;that.model.end=Math.random();that.gen=function(numSamps){var m=that.model,freq=inputs.freq.output[0],remain=numSamps,out=that.output,currSamp=0,sampsForLevel,i;freq=freq>0.001?freq:0.001;do{if(m.counter<=0){m.counter=m.sampleRate/freq;m.counter=m.counter>1?m.counter:1;if(that.options.interpolation==="linear"){m.start=m.value=m.end;m.end=Math.random();m.ramp=m.ramp=(m.end-m.start)/m.counter;}else{m.start=m.value=Math.random();m.ramp=0;}}
sampsForLevel=remain<m.counter?remain:m.counter;remain-=sampsForLevel;m.counter-=sampsForLevel;for(i=0;i<sampsForLevel;i++){out[currSamp]=m.value;m.value+=m.ramp;currSamp++;}}while(remain);that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.lfNoise",{rate:"audio",inputs:{freq:440}});flock.ugen.line=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,stepSize=m.stepSize,numSteps=m.numSteps,numLevelVals=numSteps>=numSamps?numSamps:numSteps,numEndVals=numSamps-numLevelVals,level=m.level,out=that.output,i;for(i=0;i<numLevelVals;i++){out[i]=level;numSteps--;level+=stepSize;}
if(numEndVals>0){for(i=0;i<numEndVals;i++){out[i]=level;}}
m.level=level;m.numSteps=numSteps;that.mulAdd(numSamps);};that.onInputChanged=function(){var m=that.model;m.start=that.inputs.start.output[0];m.end=that.inputs.end.output[0];m.numSteps=Math.round(that.inputs.duration.output[0]*m.sampleRate);if(m.numSteps===0){m.stepSize=0.0;m.level=m.end;}else{m.stepSize=(m.end-m.start)/m.numSteps;m.level=m.start;}
flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.line",{rate:"control",inputs:{start:0.0,end:1.0,duration:1.0}});flock.ugen.xLine=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,multiplier=m.multiplier,numSteps=m.numSteps,numLevelVals=numSteps>=numSamps?numSamps:numSteps,numEndVals=numSamps-numLevelVals,level=m.level,out=that.output,i;for(i=0;i<numLevelVals;i++){out[i]=level;numSteps--;level*=multiplier;}
if(numEndVals>0){for(i=0;i<numEndVals;i++){out[i]=level;}}
m.level=level;m.numSteps=numSteps;that.mulAdd(numSamps);};that.onInputChanged=function(){var m=that.model;flock.onMulAddInputChanged(that);m.start=that.inputs.start.output[0];if(m.start===0.0){m.start=Number.MIN_VALUE;}
m.end=that.inputs.end.output[0];m.numSteps=Math.round(that.inputs.duration.output[0]*m.sampleRate);m.multiplier=Math.pow(m.end/m.start,1.0/m.numSteps);m.level=m.start;};that.onInputChanged();return that;};fluid.defaults("flock.ugen.xLine",{rate:"control",inputs:{start:0.0,end:1.0,duration:1.0}});flock.ugen.phasor=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,step=inputs.step.output,trig=inputs.trigger.output,i,j,k;if(m.value===undefined){m.value=inputs.start.output[0];}
for(i=0,j=0,k=0;i<numSamps;i++,j+=m.strides.trigger,k+=m.strides.step){if((trig[j]>0.0&&m.prevTrig<=0.0)){m.value=inputs.reset.output[0];}
m.prevTrig=trig[j];if(m.value>=inputs.end.output[0]){m.value=inputs.start.output[0];}
out[i]=m.value;m.value+=step[k];}
that.mulAdd(numSamps);};that.onInputChanged=function(){that.calculateStrides();flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.phasor",{rate:"control",inputs:{start:0.0,end:1.0,reset:0.0,step:0.1,trigger:0.0},ugenOptions:{strideInputs:["trigger","step"]}});flock.ugen.env={};flock.ugen.env.simpleASR=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,out=that.output,prevGate=m.previousGate,gate=that.inputs.gate.output[0],level=m.level,stage=m.stage,currentStep=stage.currentStep,stepInc=stage.stepInc,numSteps=stage.numSteps,targetLevel=m.targetLevel,stepsNeedRecalc=false,stageTime,i;if(prevGate<=0&&gate>0){targetLevel=that.inputs.sustain.output[0];stageTime=that.inputs.attack.output[0];stepsNeedRecalc=true;}else if(gate<=0&&currentStep>=numSteps){targetLevel=that.inputs.start.output[0];stageTime=that.inputs.release.output[0];stepsNeedRecalc=true;}
if(stepsNeedRecalc){numSteps=Math.round(stageTime*m.sampleRate);stepInc=(targetLevel-level)/numSteps;currentStep=0;}
for(i=0;i<numSamps;i++){out[i]=level;currentStep++;level=currentStep<numSteps?level+stepInc:currentStep===numSteps?targetLevel:level;}
m.level=level;m.targetLevel=targetLevel;m.previousGate=gate;stage.currentStep=currentStep;stage.stepInc=stepInc;stage.numSteps=numSteps;};that.init=function(){var m=that.model;m.level=that.inputs.start.output[0];m.targetLevel=that.inputs.sustain.output[0];};that.init();return that;};fluid.defaults("flock.ugen.env.simpleASR",{rate:"control",inputs:{start:0.0,attack:0.01,sustain:1.0,release:1.0,gate:0.0},ugenOptions:{model:{previousGate:0.0,stage:{currentStep:0,stepInc:0,numSteps:0}}}});flock.ugen.amplitude=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.previousValue=0.0;that.gen=function(numSamps){var m=that.model,source=that.inputs.source.output,out=that.output,prevAtt=m.attackTime,nextAtt=that.inputs.attack.output[0],prevRel=m.releaseTime,nextRel=that.inputs.release.output[0],prevVal=m.previousValue,attCoef=m.attackCoef,relCoef=m.releaseCoef,i,val,coef;if(nextAtt!==prevAtt){m.attackTime=nextAtt;attCoef=m.attackCoef=nextAtt===0.0?0.0:Math.exp(flock.LOG01/(nextAtt*m.sampleRate));}
if(nextRel!==prevRel){m.releaseTime=nextRel;relCoef=m.releaseCoef=(nextRel===0.0)?0.0:Math.exp(flock.LOG01/(nextRel*m.sampleRate));}
for(i=0;i<numSamps;i++){val=Math.abs(source[i]);coef=val<prevVal?relCoef:attCoef;out[i]=prevVal=val+(prevVal-val)*coef;}
m.previousValue=prevVal;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.amplitude",{rate:"audio",inputs:{attack:0.01,release:0.01}});flock.ugen.normalize=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(){var max=that.inputs.max.output[0],source=that.inputs.source.output,i;that.output=flock.normalize(source,max);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.normalize",{rate:"audio",inputs:{max:1.0}});flock.ugen.out=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var sources=that.inputs.sources,buses=that.options.audioSettings.buses,bufStart=that.inputs.bus.output[0],expand=that.inputs.expand.output[0],numSources,numOutputBuses,i,j,source,rate,bus,inc,outIdx;if(typeof(sources.length)!=="number"){sources=[sources];}
numSources=sources.length;numOutputBuses=Math.max(expand,numSources);if(numSources<1){return;}
for(i=0;i<numOutputBuses;i++){source=sources[i%numSources];rate=source.rate;bus=buses[bufStart+i];inc=rate===flock.rates.AUDIO?1:0;outIdx=0;for(j=0;j<numSamps;j++,outIdx+=inc){bus[j]=bus[j]+source.output[outIdx];}}};that.onInputChanged();return that;};fluid.defaults("flock.ugen.out",{rate:"audio",inputs:{bus:0,expand:2}});flock.ugen["in"]=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.singleBusGen=function(){that.output=that.options.audioSettings.buses[that.inputs.bus.output[0]];};that.multiBusGen=function(numSamps){var busesInput=that.inputs.bus,enviroBuses=that.options.audioSettings.buses,out=that.output,i,j,busIdx;for(i=0;i<numSamps;i++){out[i]=0;for(j=0;j<busesInput.length;j++){busIdx=busesInput[j].output[0];out[i]+=enviroBuses[busIdx][i];}}};that.onInputChanged=function(){that.gen=flock.isIterable(that.inputs.bus)?that.multiBusGen:that.singleBusGen;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.in",{rate:"audio",inputs:{bus:0}});flock.ugen.filter=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,q=inputs.q.output[0],freq=inputs.freq.output[0];if(m.prevFreq!==freq||m.prevQ!==q){that.updateCoefficients(m,freq,q);}
that.filterEngine.filter(that.output,that.inputs.source.output);m.prevQ=q;m.prevFreq=freq;};that.init=function(){var recipeOpt=that.options.recipe
var recipe=typeof(recipeOpt)==="string"?flock.get(recipeOpt):recipeOpt;if(!recipe){throw new Error("Can't instantiate a flock.ugen.filter() without specifying a filter coefficient recipe.");}
that.filterEngine=new Filter(recipe.sizes.b,recipe.sizes.a);that.model.coeffs={a:that.filterEngine.a,b:that.filterEngine.b};that.updateCoefficients=flock.get(recipe,that.options.type);that.onInputChanged();};that.init();return that;};fluid.defaults("flock.ugen.filter",{inputs:{freq:440,q:1.0}});flock.ugen.filter.biquad=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,co=m.coeffs,freq=inputs.freq.output[0],q=inputs.q.output[0],source=inputs.source.output,i,w;if(m.prevFreq!==freq||m.prevQ!==q){that.updateCoefficients(m,freq,q);}
for(i=0;i<numSamps;i++){w=source[i]-co.a[0]*m.d0-co.a[1]*m.d1;out[i]=co.b[0]*w+co.b[1]*m.d0+co.b[2]*m.d1;m.d1=m.d0;m.d0=w;}
m.prevQ=q;m.prevFreq=freq;};that.onInputChanged=function(){var typeOpt=that.options.type;that.updateCoefficients=typeof(typeOpt)==="string"?flock.get(typeOpt):typeOpt;};that.init=function(){that.model.d0=0.0;that.model.d1=0.0;that.model.coeffs={a:new Float32Array(2),b:new Float32Array(3)};that.onInputChanged();};that.init();return that;};fluid.defaults("flock.ugen.filter.biquad",{inputs:{freq:440,q:1.0}});flock.ugen.filter.biquad.types={"hp":{inputDefaults:{freq:440,q:1.0},options:{type:"flock.coefficients.butterworth.highPass"}},"rhp":{inputDefaults:{freq:440,q:1.0},options:{type:"flock.coefficients.rbj.highPass"}},"lp":{inputDefaults:{freq:440,q:1.0},options:{type:"flock.coefficients.butterworth.lowPass"}},"rlp":{inputDefaults:{freq:440,q:1.0},options:{type:"flock.coefficients.rbj.lowPass"}},"bp":{inputDefaults:{freq:440,q:4.0},options:{type:"flock.coefficients.butterworth.bandPass"}},"br":{inputDefaults:{freq:440,q:1.0},options:{type:"flock.coefficients.butterworth.bandReject"}}};flock.aliasUGens("flock.ugen.filter.biquad",flock.ugen.filter.biquad.types);flock.coefficients={butterworth:{sizes:{a:2,b:3},lowPass:function(model,freq){var co=model.coeffs;var lambda=1/Math.tan(Math.PI*freq/model.sampleRate);var lambdaSquared=lambda*lambda;var rootTwoLambda=flock.ROOT2*lambda;var b0=1/(1+rootTwoLambda+lambdaSquared)
co.b[0]=b0;co.b[1]=2*b0;co.b[2]=b0;co.a[0]=2*(1-lambdaSquared)*b0;co.a[1]=(1-rootTwoLambda+lambdaSquared)*b0;},highPass:function(model,freq){var co=model.coeffs;var lambda=Math.tan(Math.PI*freq/model.sampleRate);var lambdaSquared=lambda*lambda;var rootTwoLambda=flock.ROOT2*lambda;var b0=1/(1+rootTwoLambda+lambdaSquared);co.b[0]=b0;co.b[1]=-2*b0;co.b[2]=b0;co.a[0]=2*(lambdaSquared-1)*b0;co.a[1]=(1-rootTwoLambda+lambdaSquared)*b0;},bandPass:function(model,freq,q){var co=model.coeffs;var bw=freq/q;var lambda=1/Math.tan(Math.PI*bw/model.sampleRate);var theta=2*Math.cos(flock.TWOPI*freq/model.sampleRate);var b0=1/(1+lambda);co.b[0]=b0;co.b[1]=0;co.b[2]=-b0;co.a[0]=-(lambda*theta*b0);co.a[1]=b0*(lambda-1);},bandReject:function(model,freq,q){var co=model.coeffs;var bw=freq/q;var lambda=Math.tan(Math.PI*bw/model.sampleRate);var theta=2*Math.cos(flock.TWOPI*freq/model.sampleRate);var b0=1/(1+lambda);var b1=-theta*b0;co.b[0]=b0;co.b[1]=b1;co.b[2]=b0;co.a[0]=b1;co.a[1]=(1-lambda)*b0;}},rbj:{sizes:{a:2,b:3},lowPass:function(model,freq,q){var co=model.coeffs;var w0=flock.TWOPI*freq/model.sampleRate;var cosw0=Math.cos(w0);var sinw0=Math.sin(w0);var bw=freq/q;var alpha=sinw0/(2*q);var oneLessCosw0=1-cosw0;var a0=1+alpha;var b0=(oneLessCosw0/2)/a0;co.b[0]=b0;co.b[1]=oneLessCosw0/a0;co.b[2]=b0;co.a[0]=(-2*cosw0)/a0;co.a[1]=(1-alpha)/a0;},highPass:function(model,freq,q){var co=model.coeffs;var w0=flock.TWOPI*freq/model.sampleRate;var cosw0=Math.cos(w0);var sinw0=Math.sin(w0);var alpha=sinw0/(2*q);var onePlusCosw0=1+cosw0;var a0=1+alpha;var b0=(onePlusCosw0/2)/a0;co.b[0]=b0;co.b[1]=(-onePlusCosw0)/a0;co.b[2]=b0;co.a[0]=(-2*cosw0)/a0;co.a[1]=(1-alpha)/a0;},bandPass:function(model,freq,q){var co=model.coeffs;var w0=flock.TWOPI*freq/model.sampleRate;var cosw0=Math.cos(w0);var sinw0=Math.sin(w0);var alpha=sinw0/(2*q);var a0=1+alpha;var qByAlpha=q*alpha;co.b[0]=qByAlpha/a0;co.b[1]=0;co.b[2]=-qByAlpha/a0;co.a[0]=(-2*cosw0)/a0;co.a[1]=(1-alpha)/a0;},bandReject:function(model,freq,q){var co=model.coeffs;var w0=flock.TWOPI*freq/model.sampleRate;var cosw0=Math.cos(w0);var sinw0=Math.sin(w0);var alpha=sinw0/(2*q);var a0=1+alpha;var ra0=1/a0;var b1=(-2*cosw0)/a0;co.b[0]=ra0;co.b[1]=b1;co.b[2]=ra0;co.a[0]=b1;co.a[1]=(1-alpha)/a0;}}};flock.ugen.delay=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,source=inputs.source.output,time=inputs.time.output[0],delayBuffer=that.delayBuffer,i;if(time!==m.time){m.time=time;m.delaySamps=time*that.model.sampleRate;}
for(i=0;i<numSamps;i++){if(m.pos>=m.delaySamps){m.pos=0;}
out[i]=delayBuffer[m.pos];delayBuffer[m.pos]=source[i];m.pos++;}
that.mulAdd(numSamps);};that.onInputChanged=function(inputName){flock.onMulAddInputChanged(that);if(!inputName||inputName==="maxTime"){var delayBufferLength=that.model.sampleRate*that.inputs.maxTime.output[0];that.delayBuffer=new Float32Array(delayBufferLength);}};that.onInputChanged();return that;};fluid.defaults("flock.ugen.delay",{rate:"audio",inputs:{maxTime:1.0,time:1.0},ugenOptions:{model:{pos:0}}});flock.ugen.decay=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,source=inputs.source.output,time=inputs.time.output[0],i;if(time!==m.time){m.time=time;m.coeff=time===0.0?0.0:Math.exp(flock.LOG001/(time*that.model.sampleRate));}
if(m.coeff===0.0){for(i=0;i<numSamps;i++){out[i]=source[i];}}else{for(i=0;i<numSamps;i++){m.lastSamp=source[i]+m.coeff*m.lastSamp;out[i]=m.lastSamp;}}
that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.decay",{rate:"audio",inputs:{time:1.0},ugenOptions:{model:{time:0,lastSamp:0,coeff:0}}});flock.ugen.triggerGrains=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.buffer=new Float32Array(that.output.length);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,buf=that.buffer,dur=inputs.dur.output[0],amp=inputs.amp.output,centerPos=inputs.centerPos.output,trigger=inputs.trigger.output,speed=inputs.speed.output,posIdx=0,trigIdx=0,ampIdx=0,speedIdx=0,i,j,k,grain,start,samp;if(dur!==m.dur){m.dur=dur>m.maxDur?m.maxDur:dur;m.numGrainSamps=Math.round(m.sampleRate*m.dur);m.grainCenter=Math.round(m.numGrainSamps/2);for(i=0;i<m.numGrainSamps;i++){m.env[i]=Math.sin(Math.PI*i/m.numGrainSamps);}}
for(i=0;i<numSamps;i++){if(trigger[trigIdx]>0.0&&m.prevTrigger<=0.0&&m.activeGrains.length<m.maxNumGrains){grain=m.freeGrains.pop();grain.sampIdx=0;grain.envIdx=0;grain.amp=amp[ampIdx];start=(centerPos[posIdx]*m.sampleRate)-m.grainCenter;while(start<0){start+=buf.length;}
grain.readPos=Math.round(start);grain.writePos=i;grain.speed=speed[speedIdx];m.activeGrains.push(grain);}
m.prevTrigger=trigger[trigIdx];out[i]=0.0;posIdx+=m.strides.centerPos;trigIdx+=m.strides.trigger;ampIdx+=m.strides.amp;speedIdx+=m.strides.speed;}
for(j=0;j<m.activeGrains.length;){grain=m.activeGrains[j];for(k=grain.writePos;k<Math.min(m.numGrainSamps-grain.sampIdx,numSamps);k++){samp=that.interpolate?that.interpolate(grain.readPos,buf):buf[grain.readPos|0];out[k]+=samp*m.env[grain.envIdx]*grain.amp;grain.readPos=(grain.readPos+grain.speed)%buf.length;grain.sampIdx++;grain.envIdx++;}
if(grain.sampIdx>=m.numGrainSamps){m.freeGrains.push(grain);m.activeGrains.splice(j,1);}else{j++;grain.writePos=grain.writePos%that.options.audioSettings.rates.control;}}
that.mulAdd(numSamps);};that.onInputChanged=function(inputName){var m=that.model,inputs=that.inputs;if(m.bufDef!==inputs.buffer||inputName==="buffer"){flock.buffer.resolveBuffer(that);}
that.calculateStrides();flock.onMulAddInputChanged(that);};that.allocateGrains=function(numGrains){numGrains=numGrains||that.model.maxNumGrains
for(var i=0;i<numGrains;i++){that.model.freeGrains.push({sampIdx:0,envIdx:0,readPos:0});}};that.init=function(){var m=that.model,maxGrainLength=Math.round(m.maxDur*m.sampleRate);that.model.env=new Float32Array(maxGrainLength);that.allocateGrains();that.onInputChanged();};that.init();return that;};fluid.defaults("flock.ugen.triggerGrains",{rate:"audio",inputs:{centerPos:0,channel:0,amp:1.0,dur:0.1,speed:1.0},ugenOptions:{model:{maxDur:30,maxNumGrains:512,activeGrains:[],freeGrains:[],env:null,strides:{}},strideInputs:["centerPos","trigger","amp","speed"],interpolation:"cubic"}});flock.ugen.print=function(input,output,options){var that=flock.ugen(input,output,options);that.model.label=that.options.label?that.options.label+": ":"";that.gen=function(numSamps){var inputs=that.inputs,m=that.model,label=m.label,source=inputs.source.output,trig=inputs.trigger.output[0],freq=inputs.freq.output[0],freq=freq,i;if(trig>0.0&&m.prevTrig<=0.0){fluid.log(label+source);}
if(m.freq!==freq){m.sampInterval=Math.round(m.sampleRate/freq);m.freq=freq;m.counter=m.sampInterval;}
for(i=0;i<numSamps;i++){if(m.counter>=m.sampInterval){fluid.log(label+source[i]);m.counter=0;}
m.counter++;that.output[i]=source[i];}};return that;};fluid.defaults("flock.ugen.print",{rate:"control",inputs:{trigger:0.0,freq:1.0},ugenOptions:{model:{counter:0}}});flock.ugen.granulator=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,inputs=that.inputs,out=that.output,grainDur=inputs.grainDur.output[0],delayDur=inputs.delayDur.output[0],numGrains=inputs.numGrains.output[0],source=inputs.source.output,i,j,grainPos,windowPos,amp;if(m.delayDur!==delayDur){m.delayDur=delayDur;m.delayLength=(m.sampleRate*m.delayDur)|0;that.delayLine=new Float32Array(that.model.delayLength);}
if(m.grainDur!==grainDur){m.grainDur=grainDur;m.grainLength=(m.sampleRate*m.grainDur)|0;for(i=0;i<m.grainLength;i++){m.windowFunction[i]=Math.sin(Math.PI*i/m.grainLength);}}
if(m.rawNumGrains!==numGrains){m.rawNumGrains=numGrains;numGrains=Math.round(numGrains);for(i=m.numGrains;i<numGrains;i++){m.currentGrainPosition[i]=0;m.currentGrainWindowPosition[i]=(Math.random()*m.grainLength)|0;}
m.numGrains=numGrains;}
for(i=0;i<numSamps;i++){that.delayLine[m.writePos]=source[i];m.writePos=(m.writePos+1)%m.delayLength;out[i]=0;for(j=0;j<m.numGrains;j++){grainPos=m.currentGrainPosition[j];windowPos=m.currentGrainWindowPosition[j];amp=m.windowFunction[windowPos];out[i]+=that.delayLine[grainPos]*amp;m.currentGrainPosition[j]=(grainPos+1)%m.delayLength;m.currentGrainWindowPosition[j]=(windowPos+1)%m.grainLength;if(m.currentGrainWindowPosition[j]===0){m.currentGrainPosition[j]=(Math.random()*m.delayLength)|0;}}
out[i]/=m.numGrains;}
that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.granulator",{rate:"audio",inputs:{grainDur:0.1,delayDur:1,numGrains:5},ugenOptions:{model:{grainLength:0,numGrains:0,currentGrainPosition:[],currentGrainWindowPosition:[],windowFunction:[],writePos:0}}});flock.ugen.sequence=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.scale=that.model.sampleDur;that.gen=function(numSamps){var list=that.buffer,inputs=that.inputs,freq=inputs.freq.output,loop=inputs.loop.output[0],m=that.model,scale=m.scale,out=that.output,start,end,i,j,val;if(!list){for(i=0;i<numSamps;i++){out[i]=0.0;}
return;}
start=inputs.start?Math.round(inputs.start.output[0]):0,end=inputs.end?Math.round(inputs.end.output[0]):list.length,m.value=m.value===undefined?list[start]:m.value;m.nextIdx=m.nextIdx===undefined?start:m.nextIdx;for(i=0,j=0;i<numSamps;i++,j+=m.strides.freq){if(m.nextIdx>=end){if(loop>0.0){m.nextIdx=start;}else{out[i]=m.value;continue;}}
out[i]=m.value=list[m.nextIdx];m.phase+=freq[j]*scale;if(m.phase>=1.0){m.phase=0.0;m.nextIdx++;}}
that.mulAdd(numSamps);};that.onInputChanged=function(inputName){that.calculateStrides();flock.onMulAddInputChanged(that);flock.buffer.resolveBuffer(that);};that.onInputChanged();return that;};fluid.defaults("flock.ugen.sequence",{rate:"control",inputs:{start:0,freq:1.0,loop:0.0},ugenOptions:{model:{phase:0},strideInputs:["freq"]}});}());