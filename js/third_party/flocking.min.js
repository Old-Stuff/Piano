
var flock=flock||{};(function($){"use strict";flock.OUT_UGEN_ID="flocking-out";flock.TWOPI=2.0*Math.PI;flock.LOG1=Math.log(0.1);flock.LOG001=Math.log(0.001);flock.rates={AUDIO:"audio",CONTROL:"control",CONSTANT:"constant"};flock.platform={os:window.navigator.platform||"",browser:$.browser};flock.defaults=function(name,defaults){if(defaults){flock.defaults.store[name]=defaults;return defaults;}
return flock.defaults.store[name];};flock.defaults.store={};flock.defaults("flock.audioSettings",{rates:{audio:44100,control:64,constant:1},tableSize:8192,bufferSize:flock.platform.os.indexOf("Linux")>-1||(flock.platform.os==="Win32"&&flock.platform.browser.mozilla)?4096:2048});flock.idIdx=0;flock.id=function(){return"flock-id-"+flock.idIdx++;};flock.identity=function(val){return val;};flock.isIterable=function(o){return o&&o.length!==undefined&&typeof(o.length)==="number";};flock.generate=function(bufOrSize,generator){var buf=typeof(bufOrSize)==="number"?new Float32Array(bufOrSize):bufOrSize,i;if(typeof(generator)==="number"){var value=generator;generator=function(){return value;};}
for(i=0;i<buf.length;i++){buf[i]=generator(i,buf);}
return buf;};flock.generate.silence=function(bufOrSize){if(typeof(bufOrSize)==="number"){return new Float32Array(bufOrSize);}
var buf=bufOrSize,i;for(i=0;i<buf.length;i++){buf[i]=0.0;}
return buf;};flock.minBufferSize=function(latency,audioSettings){var size=(audioSettings.rates.audio*audioSettings.chans)/(1000/latency);return Math.round(size);};flock.randomIndex=function(arr){var max=arr.length-1;return Math.round(Math.random()*max);};flock.arrayChoose=function(arr,strategy){strategy=strategy||flock.randomIndex;arr=$.makeArray(arr);var idx=strategy(arr);return arr[idx];};flock.choose=function(collection,strategy){if(flock.isIterable(collection)){var val=flock.arrayChoose(collection,strategy);return val;}
var key=flock.arrayChoose(collection.keys,strategy);return collection[key];};flock.normalize=function(buffer,normal){var maxVal=0.0,i,current,val;normal=normal===undefined?1.0:normal;for(i=0;i<buffer.length;i++){current=Math.abs(buffer[i]);if(current>maxVal){maxVal=current;}}
if(maxVal>0.0){for(i=0;i<buffer.length;i++){val=buffer[i];buffer[i]=(val/maxVal)*normal;}}
return buffer;};flock.pathParseError=function(path,token){throw new Error("Error parsing path: "+path+". Segment '"+token+"' could not be resolved.");};flock.get=function(root,path){root=root||window;var tokenized=path===""?[]:String(path).split("."),valForSeg=root[tokenized[0]],i;for(i=1;i<tokenized.length;i++){if(valForSeg===null||valForSeg===undefined){flock.pathParseError(path,tokenized[i-1]);}
valForSeg=valForSeg[tokenized[i]];}
return valForSeg;};flock.set=function(root,path,value){root=root||window;if(!path||path===""){return;}
var tokenized=String(path).split("."),l=tokenized.length,prop=tokenized[0],i,type;for(i=1;i<l;i++){root=root[prop];type=typeof(root);if(type!=="object"){throw new Error("A non-container object was found at segment "+prop+". Value: "+root);}
prop=tokenized[i];if(root[prop]===undefined){root[prop]={};}}
root[prop]=value;return value;};flock.invoke=function(root,path,args){var fn=flock.get(root,path);if(typeof(fn)!=="function"){throw new Error("Path '"+path+"' does not resolve to a function.");}
return fn.apply(null,args);};flock.input={};flock.input.pathExpander=function(path){return path.replace(/\.(?![0-9])/g,".inputs.");};flock.input.expandPaths=function(paths){var expanded={},path,expandedPath,value;for(path in paths){expandedPath=flock.input.pathExpander(path);value=paths[path];expanded[expandedPath]=value;}
return expanded;};flock.input.expandPath=function(path){return(typeof(path)==="string")?flock.input.pathExpander(path):flock.input.expandPaths(path);};flock.input.getValueForPath=function(root,path){path=flock.input.expandPath(path);var input=flock.get(root,path);return(input&&input.model&&typeof(input.model.value)!=="undefined")?input.model.value:input;};flock.input.getValuesForPathArray=function(root,paths){var values={},i,path;for(i=0;i<paths.length;i++){path=paths[i];values[path]=flock.input.get(root,path);}
return values;};flock.input.getValuesForPathObject=function(root,pathObj){var key;for(key in pathObj){pathObj[key]=flock.input.get(root,key);}
return pathObj;};flock.input.get=function(root,path){return typeof(path)==="string"?flock.input.getValueForPath(root,path):flock.isIterable(path)?flock.input.getValuesForPathArray(root,path):flock.input.getValuesForPathObject(root,path);};flock.input.setValueForPath=function(root,path,val,baseTarget,valueParser){path=flock.input.expandPath(path);var previousInput=flock.get(root,path),lastDotIdx=path.lastIndexOf("."),inputName=path.slice(lastDotIdx+1),target=lastDotIdx>-1?flock.get(root,path.slice(0,path.lastIndexOf(".inputs"))):baseTarget,newInput=valueParser?valueParser(val,path,target,previousInput):val;flock.set(root,path,newInput);if(target&&target.onInputChanged){target.onInputChanged(inputName);}
return newInput;};flock.input.setValuesForPaths=function(root,valueMap,baseTarget,valueParser){var resultMap={},path,val,result;for(path in valueMap){val=valueMap[path];result=flock.input.set(root,path,val,baseTarget,valueParser);resultMap[path]=result;}
return valueMap;};flock.input.set=function(root,path,val,baseTarget,valueParser){return typeof(path)==="string"?flock.input.setValueForPath(root,path,val,baseTarget,valueParser):flock.input.setValuesForPaths(root,path,baseTarget,valueParser);};flock.component=function(name,options){var that={options:$.extend({},flock.defaults(name),options)};return that;};flock.scheduler={};flock.shim={URL:window.URL||window.webkitURL||window.msURL||window.oURL};flock.worker=function(code){var type=typeof(code),url,blob;if(type==="function"){code="("+code.toString()+")();";}else if(type!=="string"){throw new Error("A flock.worker must be initialized with a String or a Function.");}
if(window.Blob){blob=new Blob([code]);url=flock.shim.URL.createObjectURL(blob);}else{url="data:text/javascript;base64,"+window.btoa(code);}
return new Worker(url);};flock.worker.code={interval:function(){self.scheduled={};self.onInterval=function(interval){self.postMessage({msg:"tick",value:interval});};self.schedule=function(interval){var id=setInterval(function(){self.onInterval(interval);},interval);self.scheduled[interval]=id;};self.clear=function(interval){var id=self.scheduled[interval];clearInterval(id);};self.clearAll=function(){for(var interval in self.scheduled){self.clear(interval);}};self.addEventListener("message",function(e){self[e.data.msg](e.data.value);},false);},specifiedTime:function(){self.scheduled=[];self.schedule=function(timeFromNow){var id;id=setTimeout(function(){self.clear(id);self.postMessage({msg:"tick",value:[timeFromNow,Date.now()]});});self.scheduled.push(id);};self.clear=function(id,idx){idx=idx===undefined?self.scheduled.indexOf(id):idx;if(idx>-1){self.scheduled.splice(idx,1);}
clearTimeout(id);};self.clearAll=function(){for(var i=0;i<self.scheduled.length;i++){var id=self.scheduled[i];clearTimeout(id);}
self.scheduled.length=0;};self.addEventListener("message",function(e){self[e.data.msg](e.data.value);},false);}};flock.scheduler.async=function(){var that={messages:{schedule:{msg:"schedule"},clear:{msg:"clear"},clearAll:{msg:"clearAll"}},listeners:[]};that.addOneShotListener=function(eventName,target,fn){var listener=function(e){fn.apply(null,e.data.value);target.removeEventListener(eventName,listener,false);};target.addEventListener(eventName,listener,false);return listener;};that.addFilteredListener=function(eventName,target,value,fn){var listener=function(e){if(e.data.value===value){fn();}};target.addEventListener(eventName,listener,false);that.listeners[eventName]=that.listeners[eventName]||[];that.listeners[eventName].push({listener:listener,value:value});return listener;};that.removeFilteredListener=function(eventName,target,value,fn){var listener;$.each(that.listeners[eventName],function(i,events){if(events.value===value){listener=events.listener;target.removeEventListener(eventName,listener,false);}});return listener;};that.repeat=function(interval,fn){var worker=that.workers.interval;that.addFilteredListener("message",worker,interval,fn);that.scheduleWorker(worker,interval);};that.once=function(time,fn){var worker=that.workers.specifiedTime;that.addOneShotListener("message",worker,fn);that.scheduleWorker(worker,time);};that.sequence=function(times,fn){for(var i=0;i<times.length;i++){that.once(times[i],fn);}};that.scheduleWorker=function(worker,value){var msg=that.messages.schedule;msg.value=value;worker.postMessage(msg);};that.clearRepeat=function(interval,fn){var msg=that.messages.clear,worker=that.workers.interval;that.removeFilteredListener("message",worker,interval,fn);msg.value=interval;that.workers.interval.postMessage(msg);};that.clearAll=function(){var key,worker;for(key in that.workers){worker=that.workers[key];worker.postMessage(that.messages.clearAll);}};that.init=function(){that.workers={};var workerTypes=flock.worker.code,worker;for(var type in workerTypes){worker=flock.worker(workerTypes[type]);that.workers[type]=worker;}};that.init();return that;};var setupEnviro=function(that){var setupFn=typeof(window.webkitAudioContext)!=="undefined"?flock.enviro.webkit:flock.enviro.moz;setupFn(that);};flock.enviro=function(options){options=options||{};var defaultSettings=flock.defaults("flock.audioSettings"),that={audioSettings:{rates:{audio:options.sampleRate||defaultSettings.rates.audio,control:options.controlRate||defaultSettings.rates.control,constant:options.constantRate||defaultSettings.rates.constant},chans:options.chans||2,bufferSize:options.bufferSize||defaultSettings.bufferSize,numBuses:options.numBuses||16},model:{playState:{written:0,total:null}},nodes:[],isPlaying:false};that.buses=flock.enviro.createAudioBuffers(that.audioSettings.numBuses,that.audioSettings.rates.control);that.buffers={};that.asyncScheduler=flock.scheduler.async();that.play=function(dur){var playState=that.model.playState,sps=dur*(that.audioSettings.rates.audio*that.audioSettings.chans);playState.total=dur===undefined?Infinity:playState.total===Infinity?sps:playState.written+sps;that.startGeneratingSamples();that.isPlaying=true;};that.stop=function(){that.stopGeneratingSamples();that.isPlaying=false;};that.reset=function(){that.stop();that.asyncScheduler.clearAll();while(that.nodes.length>0){that.nodes.pop();}};that.gen=function(){that.clearBuses();flock.enviro.evalGraph(that.nodes,that.audioSettings.rates.control);};that.head=function(node){that.nodes.unshift(node);};that.before=function(refNode,node){var refIdx=that.nodes.indexOf(refNode);that.at(refIdx,node);};that.after=function(refNode,node){var refIdx=that.nodes.indexOf(refNode);that.at(refIdx+1,node);};that.at=function(idx,node){that.nodes.splice(idx,0,node);};that.tail=function(node){that.nodes.push(node);};that.remove=function(node){var idx=that.nodes.indexOf(node);that.nodes.splice(idx,1);};that.loadBuffer=function(name,src,onLoadFn){if(!src&&onLoadFn){onLoadFn(that.buffers[name],name);return;}
flock.audio.decode(src,function(decoded){var chans=decoded.data.channels;that.buffers[name]=chans;if(onLoadFn){onLoadFn(chans,name);}});};that.clearBuses=function(){var numBuses=that.audioSettings.numBuses,buses=that.buses,i,bus,j;for(i=0;i<numBuses;i++){bus=buses[i];for(j=0;j<bus.length;j++){bus[j]=0;}}};setupEnviro(that);return that;};flock.enviro.createAudioBuffers=function(numBufs,kr){var bufs=[],i;for(i=0;i<numBufs;i++){bufs[i]=new Float32Array(kr);}
return bufs;};flock.enviro.evalGraph=function(nodes,kr){var i,node;for(i=0;i<nodes.length;i++){node=nodes[i];node.gen(node.rate===flock.rates.AUDIO?kr:1);}};flock.interleavedDemandWriter=function(outBuf,evalFn,sourceBufs,audioSettings){var kr=audioSettings.rates.control,chans=audioSettings.chans,numKRBufs=audioSettings.bufferSize/kr,i,chan,samp;for(i=0;i<numKRBufs;i++){evalFn();var offset=i*kr*chans;for(chan=0;chan<chans;chan++){var sourceBuf=sourceBufs[chan];for(samp=0;samp<kr;samp++){var frameIdx=samp*chans+offset;outBuf[frameIdx+chan]=sourceBuf[samp];}}}
return outBuf;};flock.enviro.moz=function(that){that.audioEl=new Audio();that.model.writeInterval=1;that.model.sampleOverflow=-(that.audioSettings.bufferSize*4);that.audioEl.mozSetup(that.audioSettings.chans,that.audioSettings.rates.audio);that.startGeneratingSamples=function(){if(that.scheduled){return;}
that.asyncScheduler.repeat(that.model.writeInterval,that.writeSamples);that.scheduled=true;};that.writeSamples=function(){var playState=that.model.playState,currentOffset=that.audioEl.mozCurrentSampleOffset(),needed=currentOffset-playState.written,outBuf;if(needed<that.model.sampleOverflow||that.nodes.length<1){return;}
outBuf=new Float32Array(that.audioSettings.bufferSize*that.audioSettings.chans);flock.interleavedDemandWriter(outBuf,that.gen,that.buses,that.audioSettings);playState.written+=that.audioEl.mozWriteAudio(outBuf);if(playState.written>=playState.total){that.stop();}};that.stopGeneratingSamples=function(){that.asyncScheduler.clearRepeat(that.model.writeInterval);that.scheduled=false;};};var setupWebKitEnviro=function(that){that.jsNode.onaudioprocess=function(e){var defaultSettings=flock.defaults("flock.audioSettings"),kr=defaultSettings.rates.control,playState=that.model,chans=that.audioSettings.chans,bufSize=that.audioSettings.bufferSize,numKRBufs=bufSize/kr,sourceBufs=that.buses,outBufs=e.outputBuffer,i,chan,samp;if(that.nodes.length<1){for(chan=0;chan<chans;chan++){flock.generate.silence(outBufs.getChannelData(chan));}
return;}
for(i=0;i<numKRBufs;i++){that.gen();var offset=i*kr;for(chan=0;chan<chans;chan++){var sourceBuf=sourceBufs[chan],outBuf=outBufs.getChannelData(chan);for(samp=0;samp<kr;samp++){outBuf[samp+offset]=sourceBuf[samp];}}}
playState.written+=bufSize*chans;if(playState.written>=playState.total){that.stop();}};that.source.connect(that.jsNode);};flock.enviro.webkit=function(that){that.context=new webkitAudioContext();that.source=that.context.createBufferSource();that.jsNode=that.context.createJavaScriptNode(that.audioSettings.bufferSize);that.startGeneratingSamples=function(){that.jsNode.connect(that.context.destination);};that.stopGeneratingSamples=function(){that.jsNode.disconnect(0);};setupWebKitEnviro(that);};flock.enviro.shared=flock.enviro();flock.synth=function(def,options){var that={rate:flock.rates.AUDIO,enviro:flock.enviro.shared,ugens:flock.synth.ugenCache(),model:{synthDef:def},options:options||{}};that.gen=function(){flock.enviro.evalGraph(that.ugens.active,that.enviro.audioSettings.rates.control);};that.get=function(path){return flock.input.get(that.ugens.named,path);};that.set=function(path,val,swap){return flock.input.set(that.ugens.named,path,val,undefined,function(ugenDef,path,target,previous){var ugen=flock.parse.ugenDef(ugenDef,that.enviro.audioSettings.rates);that.ugens.replace(ugen,previous,swap);return ugen;});};that.input=function(path,val,swap){return!path?undefined:typeof(path)==="string"?arguments.length<2?that.get(path):that.set(path,val,swap):flock.isIterable(path)?that.get(path):that.set(path,val,swap);};that.play=function(){var e=that.enviro;if(e.nodes.indexOf(that)===-1){e.head(that);}
if(!e.isPlaying){e.play();}};that.pause=function(){that.enviro.remove(that);};that.init=function(){var parseOptions=$.extend({},that.enviro.audioSettings,{visitors:that.ugens.add});that.out=flock.parse.synthDef(that.model.synthDef,parseOptions);if(that.options.addToEnvironment!==false){that.enviro.tail(that);}};that.init();return that;};flock.synth.ugenCache=function(){var that={named:{},active:[]};that.add=function(ugens){var i,ugen;ugens=$.makeArray(ugens);for(i=0;i<ugens.length;i++){ugen=ugens[i];if(ugen.gen){that.active.push(ugen);}
if(ugen.id){that.named[ugen.id]=ugen;}}};that.remove=function(ugens,recursively){var active=that.active,named=that.named,i,ugen,idx,inputs,input;ugens=$.makeArray(ugens);for(i=0;i<ugens.length;i++){ugen=ugens[i];idx=active.indexOf(ugen);if(idx>-1){active.splice(idx,1);}
if(ugen.id){delete named[ugen.id];}
if(recursively){inputs=[];for(input in ugen.inputs){inputs.push(ugen.inputs[input]);}
that.remove(inputs,true);}}};that.reattachInputs=function(currentUGen,previousUGen,inputsToReattach){var i,inputName;if(inputsToReattach){for(i=0;i<inputsToReattach.length;i++){inputName=inputsToReattach[i];currentUGen.inputs[inputName]=previousUGen.inputs[inputName];}}else{currentUGen.inputs=previousUGen.inputs;}};that.replaceActiveOutput=function(currentUGen,previousUGen){var i,ugen,inputName,input;for(i=0;i<that.active.length;i++){ugen=that.active[i];for(inputName in ugen.inputs){input=ugen.inputs[inputName];if(input===previousUGen){ugen.inputs[inputName]=currentUGen;break;}}}
return currentUGen;};that.swap=function(ugens,previousUGens,inputsToReattach){var i,prev,current;previousUGens=$.makeArray(previousUGens);ugens=$.makeArray(ugens);for(i=0;i<previousUGens.length;i++){prev=previousUGens[i];current=ugens[i];that.reattachInputs(current,prev,inputsToReattach);that.replaceActiveOutput(current,prev);}
return ugens;};that.replace=function(ugens,previousUGens,reattachInputs){if(reattachInputs){reattachInputs=typeof(reattachInputs)==="object"?reattachInputs:undefined;that.swap(ugens,previousUGens,reattachInputs);}
that.remove(previousUGens,true);that.add(ugens);return ugens;};return that;};flock.synth.group=function(defs,options){};flock.synth.polyphonic=function(def,options){var that=flock.component("flock.synth.polyphonic",options);that.model={synthDef:def};that.activeVoices={};that.freeVoices=[];that.allVoices=[];that.input=function(){that.dispatchToVoices("input",arguments);};that.get=function(){that.dispatchToVoices("get",arguments);};that.set=function(){that.dispatchToVoices("set",arguments);};that.dispatchToVoices=function(msg,args){var i,voice,val;for(i=0;i<that.allVoices.length;i++){voice=that.allVoices[i];val=voice[msg].apply(voice,args);}
return val;};that.noteChange=function(voice,eventName,changeSpec){var noteEventSpec=that.options.noteSpecs[eventName];changeSpec=$.extend({},noteEventSpec,changeSpec);voice.input(changeSpec);};that.noteOn=function(noteName,changeSpec){var voice=that.nextFreeVoice();if(that.activeVoices[noteName]){that.noteOff(noteName);}
that.activeVoices[noteName]=voice;that.noteChange(voice,"on",changeSpec);return voice;};that.noteOff=function(noteName,changeSpec){var voice=that.activeVoices[noteName];if(!voice){return null;}
that.noteChange(voice,"off",changeSpec);delete that.activeVoices[noteName];that.freeVoices.push(voice);return voice;};that.createVoice=function(){var voice=flock.synth(that.model.synthDef),normalizer=that.options.amplitudeNormalizer,ampKey=that.options.amplitudeKey,normValue;if(normalizer){if(typeof(normalizer)==="function"){norm(voice,ampKey);}else if(normalizer==="static"){normValue=1.0/that.options.maxVoices;voice.input(ampKey,normValue);}}
that.allVoices.push(voice);return voice;};that.pooledVoiceAllocator=function(){return that.freeVoices.pop();};that.lazyVoiceAllocator=function(){return that.freeVoices.length>1?that.freeVoices.pop():Object.keys(that.activeVoices).length>that.options.maxVoices?null:that.createVoice();};that.init=function(){if(!that.options.initVoicesLazily){for(var i=0;i<that.options.maxVoices;i++){that.freeVoices[i]=that.createVoice();}
that.nextFreeVoice=that.pooledVoiceAllocator;}else{that.nextFreeVoice=that.lazyVoiceAllocator;}};that.init();return that;};flock.defaults("flock.synth.polyphonic",{noteSpecs:{on:{"env.gate":1},off:{"env.gate":0}},maxVoices:16,initVoicesLazily:true,amplitudeKey:"env.sustain",amplitudeNormalizer:"static"});}(jQuery));
var flock=flock||{};(function($){"use strict";flock.parse=flock.parse||{};flock.parse.synthDef=function(ugenDef,options){if(typeof(ugenDef.length)==="number"||(ugenDef.id!==flock.OUT_UGEN_ID&&ugenDef.ugen!=="flock.ugen.out")){ugenDef={id:flock.OUT_UGEN_ID,ugen:"flock.ugen.out",inputs:{sources:ugenDef,bus:0,expand:options.chans}};}
return flock.parse.ugenForDef(ugenDef,options.rates,options.visitors);};flock.parse.makeUGen=function(ugenDef,parsedInputs,rates){if(!ugenDef.rate){ugenDef.rate=flock.rates.AUDIO;}
var buffer=new Float32Array(ugenDef.rate===flock.rates.AUDIO?rates.control:1),sampleRate;if(ugenDef.options&&ugenDef.options.sampleRate!==undefined){sampleRate=ugenDef.options.sampleRate;}else if(ugenDef.rate===flock.rates.AUDIO){sampleRate=rates.audio;}else if(ugenDef.rate===flock.rates.CONTROL){sampleRate=rates.audio/rates.control;}else{sampleRate=1;}
ugenDef.options=ugenDef.options||{};ugenDef.options.sampleRate=sampleRate;ugenDef.options.rate=ugenDef.rate;ugenDef.options.audioSettings={rates:rates};return flock.invoke(undefined,ugenDef.ugen,[parsedInputs,buffer,ugenDef.options]);};flock.parse.reservedWords=["id","ugen","rate","inputs","options"];flock.parse.specialInputs=["value","buffer","table"];flock.parse.expandUGenDef=function(ugenDef){var inputs={},prop;for(prop in ugenDef){if(flock.parse.reservedWords.indexOf(prop)===-1){inputs[prop]=ugenDef[prop];delete ugenDef[prop];}}
ugenDef.inputs=inputs;return ugenDef;};flock.parse.expandValueDef=function(ugenDef){var type=typeof(ugenDef);if(type==="number"){return{ugen:"flock.ugen.value",rate:flock.rates.CONSTANT,inputs:{value:ugenDef}};}
if(type==="object"){return ugenDef;}
throw new Error("Invalid value type found in ugen definition.");};flock.parse.rateMap={"ar":flock.rates.AUDIO,"kr":flock.rates.CONTROL,"cr":flock.rates.CONSTANT};flock.parse.expandRate=function(ugenDef){ugenDef.rate=flock.parse.rateMap[ugenDef.rate]||ugenDef.rate;return ugenDef;};flock.parse.ugenDef=function(ugenDefs,rates,visitors){var parseFn=flock.isIterable(ugenDefs)?flock.parse.ugensForDefs:flock.parse.ugenForDef;var parsed=parseFn(ugenDefs,rates,visitors);return parsed;};flock.parse.ugensForDefs=function(ugenDefs,rates,visitors){var parsed=[],i;for(i=0;i<ugenDefs.length;i++){parsed[i]=flock.parse.ugenForDef(ugenDefs[i],rates,visitors);}
return parsed;};flock.parse.ugenForDef=function(ugenDef,rates,visitors){var defaultSettings=flock.defaults("flock.audioSettings");rates=rates||defaultSettings.rates;ugenDef=flock.parse.expandValueDef(ugenDef);if(flock.isIterable(ugenDef)){return flock.parse.ugensForDefs(ugenDef,rates,visitors);}
if(!ugenDef.inputs){ugenDef=flock.parse.expandUGenDef(ugenDef);}
flock.parse.expandRate(ugenDef);var defaults=flock.defaults(ugenDef.ugen)||{};ugenDef=$.extend(true,{},defaults,ugenDef);var inputDefs=ugenDef.inputs,inputs={},inputDef;for(inputDef in inputDefs){inputs[inputDef]=flock.parse.specialInputs.indexOf(inputDef)>-1?ugenDef.inputs[inputDef]:flock.parse.ugenForDef(ugenDef.inputs[inputDef],rates,visitors);}
if(!ugenDef.ugen){throw new Error("Unit generator definition lacks a 'ugen' property; can't initialize the synth graph.");}
var ugen=flock.parse.makeUGen(ugenDef,inputs,rates);ugen.id=ugenDef.id;if(visitors){visitors=$.makeArray(visitors);$.each(visitors,function(idx,visitor){visitor(ugen,ugenDef,rates);});}
return ugen;};flock.parse.bufferForDef=function(bufDef,onLoad,enviro){enviro=enviro||flock.enviro.shared;var id=bufDef.id||flock.id(),src;if(bufDef.url){src=bufDef.url;}else if(bufDef.selector){src=document.querySelector(bufDef.selector).files[0];}
enviro.loadBuffer(id,src,onLoad);};}(jQuery));
var flock=flock||{};(function($){"use strict";flock.ugen=function(inputs,output,options){options=options||{};var that={rate:options.rate||flock.rates.AUDIO,inputs:inputs,output:output,options:options,model:{}};that.options.audioSettings=that.options.audioSettings||flock.enviro.shared.audioSettings;that.sampleRate=options.sampleRate||that.options.audioSettings.rates[that.rate];that.get=function(path){return flock.input.get(that.inputs,path);};that.set=function(path,val,swap){return flock.input.set(that.inputs,path,val,that,function(ugenDef){return flock.parse.ugenDef(ugenDef,that.options.audioSettings.rates);});};that.input=function(path,val){return!path?undefined:typeof(path)==="string"?arguments.length<2?that.get(path):that.set(path,val):flock.isIterable(path)?that.get(path):that.set(path,val);};that.onInputChanged=flock.identity;return that;};flock.krMul=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul;}};flock.mul=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i];}};flock.krAdd=function(numSamps,output,mulInput,addInput){var add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]+add;}};flock.add=function(numSamps,output,mulInput,addInput){var add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]+add[i];}};flock.krMulAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul+add[i];}};flock.mulKrAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i]+add;}};flock.krMulKrAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output[0],add=addInput.output[0],i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul+add;}};flock.mulAdd=function(numSamps,output,mulInput,addInput){var mul=mulInput.output,add=addInput.output,i;for(i=0;i<numSamps;i++){output[i]=output[i]*mul[i]+add[i];}};flock.onMulAddInputChanged=function(that){var mul=that.inputs.mul,add=that.inputs.add,fn;if(!mul&&!add){that.mulAdd=flock.identity;return;}
if(!mul){fn=add.rate!==flock.rates.AUDIO?flock.krAdd:flock.add;}else if(!add){fn=mul.rate!==flock.rates.AUDIO?flock.krMul:flock.mul;}else{fn=mul.rate!==flock.rates.AUDIO?(add.rate!==flock.rates.AUDIO?flock.krMulKrAdd:flock.krMulAdd):(add.rate!==flock.rates.AUDIO?flock.mulKrAdd:flock.mulAdd);}
that.mulAdd=function(numSamps){fn(numSamps,that.output,mul,add);};};flock.ugen.value=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.output[0]=that.model.value=inputs.value;return that;};flock.defaults("flock.ugen.value",{rate:"constant"});flock.ugen.sum=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.sumGen=function(numSamps){var sources=that.inputs.sources,out=that.output,i,sourceIdx,sum;for(i=0;i<numSamps;i++){sum=0;for(sourceIdx=0;sourceIdx<sources.length;sourceIdx++){sum+=sources[sourceIdx].output[i];}
out[i]=sum;}};that.onInputChanged=function(){if(typeof(that.inputs.sources.length)==="number"){that.gen=that.sumGen;}else{that.output=that.inputs.sources.output;that.gen=flock.identity;}};that.onInputChanged();return that;};flock.defaults("flock.ugen.sum",{rate:"audio"});flock.ugen.osc=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.phase=0.0;that.gen=function(numSamps){var m=that.model,inputs=that.inputs,freq=inputs.freq.output,phase=inputs.phase.output,table=inputs.table,tableLen=m.tableLen,tableIncHz=m.tableIncHz,tableIncRad=m.tableIncRad,output=that.output,phaseAccum=m.phase,phaseInc=m.phaseInc,freqInc=m.freqInc,i,j,k,idx;for(i=0,j=0,k=0;i<numSamps;i++,j+=phaseInc,k+=freqInc){idx=Math.round(phaseAccum+phase[j]*tableIncRad);if(idx>=tableLen){idx-=tableLen;}else if(idx<0){idx+=tableLen;}
output[i]=table[idx];phaseAccum+=freq[k]*tableIncHz;if(phaseAccum>=tableLen){phaseAccum-=tableLen;}else if(phaseAccum<0){phaseAccum+=tableLen;}}
m.phase=phaseAccum;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.ugen.osc.onInputChanged(that);var m=that.model;m.tableLen=that.inputs.table.length;m.tableIncHz=m.tableLen/that.sampleRate;m.tableIncRad=m.tableLen/flock.TWOPI;};that.onInputChanged();return that;};flock.ugen.osc.onInputChanged=function(that){var m=that.model,inputs=that.inputs;m.freqInc=inputs.freq.rate===flock.rates.AUDIO?1:0;m.phaseInc=inputs.phase.rate===flock.rates.AUDIO?1:0;flock.onMulAddInputChanged(that);};flock.defaults("flock.ugen.osc",{rate:"audio",inputs:{freq:440.0,phase:0.0}});flock.ugen.osc.define=function(name,tableFillFn){var lastSegIdx=name.lastIndexOf("."),namespace=name.substring(0,lastSegIdx),oscName=name.substring(lastSegIdx+1),namespaceObj=flock.get(undefined,namespace);namespaceObj[oscName]=function(inputs,output,options){var defaultSettings=flock.defaults("flock.audioSettings"),size=(options&&options.tableSize)||defaultSettings.tableSize,scale=flock.TWOPI/size;inputs.table=tableFillFn(size,scale);return flock.ugen.osc(inputs,output,options);};flock.defaults(name,flock.defaults("flock.ugen.osc"));};flock.ugen.osc.define("flock.ugen.sinOsc",function(size,scale){return flock.generate(size,function(i){return Math.sin(i*scale);});});flock.ugen.osc.fourierTable=function(size,scale,numHarms,phase,amps){phase*=flock.TWOPI;return flock.generate(size,function(i){var harm,amp,w,val=0.0;for(harm=0;harm<numHarms;harm++){amp=amps?amps[harm]:1.0;w=(harm+1)*(i*scale);val+=amp*Math.cos(w+phase);}
return val;});};flock.ugen.osc.normalizedFourierTable=function(size,scale,numHarms,phase,ampGenFn){var amps=flock.generate(numHarms,function(harm){return ampGenFn(harm+1);});var table=flock.ugen.osc.fourierTable(size,scale,numHarms,phase,amps);return flock.normalize(table);};flock.ugen.osc.define("flock.ugen.triOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,1000,1.0,function(harm){return harm%2===0?0.0:1.0/(harm*harm);});});flock.ugen.osc.define("flock.ugen.sawOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,10,-0.25,function(harm){return 1.0/harm;});});flock.ugen.osc.define("flock.ugen.squareOsc",function(size,scale){return flock.ugen.osc.normalizedFourierTable(size,scale,10,-0.25,function(harm){return harm%2===0?0.0:1.0/harm;});});flock.ugen.sin=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.phase=0.0;that.gen=function(numSamps){var m=that.model,freq=that.inputs.freq.output,phase=that.inputs.phase.output,freqInc=m.freqInc,phaseInc=m.phaseInc,out=that.output,phaseAccum=m.phase,sampleRate=that.sampleRate,i,j,k;for(i=0,j=0,k=0;i<numSamps;i++,j+=phaseInc,k+=freqInc){out[i]=Math.sin(phaseAccum+phase[j]);phaseAccum+=freq[k]/sampleRate*flock.TWOPI;}
m.phase=phaseAccum;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.ugen.osc.onInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.sin",flock.defaults("flock.ugen.osc"));flock.ugen.lfSaw=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.scale=2*(1/options.sampleRate);that.gen=function(numSamps){var m=that.model,freq=that.inputs.freq.output,freqInc=m.freqInc,out=that.output,scale=m.scale,phase=m.phase===undefined?that.inputs.phase.output[0]:m.phase,i,j;for(i=0,j=0;i<numSamps;i++,j+=freqInc){out[i]=phase;phase+=freq[j]*scale;if(phase>=1.0){phase-=2.0;}else if(phase<=-1.0){phase+=2.0;}}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){that.model.freqInc=that.inputs.freq.rate===flock.rates.AUDIO?1:0;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.lfSaw",{rate:"audio",inputs:{phase:0.0}});flock.ugen.lfPulse=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.scale=1/options.sampleRate;that.gen=function(numSamps){var inputs=that.inputs,m=that.model,freq=inputs.freq.output,freqInc=m.freqInc,width=inputs.width.output[0],out=that.output,scale=m.scale,phase=m.phase!==undefined?m.phase:inputs.phase.output[0],i,j;for(i=0,j=0;i<numSamps;i++,j+=freqInc){if(phase>=1.0){phase-=1.0;out[i]=width<0.5?1.0:-1.0;}else{out[i]=phase<width?1.0:-1.0;}
phase+=freq[j]*scale;}
m.phase=phase;that.mulAdd(numSamps);};that.onInputChanged=function(){that.model.freqInc=that.inputs.freq.rate===flock.rates.AUDIO?1:0;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.lfPulse",{rate:"audio",inputs:{phase:0.0,width:0.5}});flock.ugen.playBuffer=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model={idx:0,channel:undefined};that.buffer=new Float32Array(that.output.length);that.crRegularSpeedGen=function(numSamps){var m=that.model,out=that.output,chan=that.inputs.channel.output[0],source=that.buffer,bufIdx=m.idx,bufLen=source.length,loop=that.inputs.loop.output[0],i;if(m.channel!==chan){m.channel=chan;that.buffer=source=flock.enviro.shared.buffers[m.name][chan];}
for(i=0;i<numSamps;i++){if(bufIdx>=bufLen){if(loop>0){bufIdx=0;}else{out[i]=0.0;continue;}}
out[i]=source[bufIdx];bufIdx++;}
m.idx=bufIdx;};that.krSpeedGen=function(numSamps){var m=that.model,out=that.output,chan=that.inputs.channel.output[0],speedInc=that.inputs.speed.output[0],source=that.buffer,bufIdx=m.idx,bufLen=source.length,loop=that.inputs.loop.output[0],i;if(m.channel!==chan){m.channel=chan;that.buffer=source=flock.enviro.shared.buffers[m.name][chan];}
for(i=0;i<numSamps;i++){if(bufIdx>=bufLen){if(loop>0){bufIdx=0;}else{out[i]=0.0;continue;}}
out[i]=source[Math.round(bufIdx)];bufIdx+=speedInc;}
m.idx=bufIdx;};that.onInputChanged=function(inputName){var m=that.model,inputs=that.inputs;if(!inputs.channel){inputs.channel=flock.ugen.value({value:0.0},new Float32Array(1));m.channel=that.inputs.channel.output[0];}
if(m.bufDef!==that.inputs.buffer||inputName==="buffer"){var bufDef=m.bufDef=inputs.buffer,chan=that.inputs.channel.output[0];if(typeof(bufDef)==="string"){that.buffer=flock.enviro.shared.buffers[bufDef][chan];}else{flock.parse.bufferForDef(bufDef,function(buffer,name){that.buffer=buffer?buffer[inputs.channel.output[0]]:that.buffer;m.name=name;m.idx=0;});}}
that.gen=(inputs.speed.rate===flock.rates.CONSTANT&&inputs.speed.output[0]===1.0)?that.crRegularSpeedGen:that.krSpeedGen;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.playBuffer",{rate:"audio",inputs:{loop:0.0,speed:1.0}});flock.ugen.dust=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model={density:0.0,scale:0.0,threshold:0.0,sampleDur:1.0/that.sampleRate};that.gen=function(numSamps){var m=that.model,density=inputs.density.output[0],threshold,scale,val,i;if(density!==m.density){m.density=density;threshold=m.threshold=density*m.sampleDur;scale=m.scale=threshold>0.0?1.0/threshold:0.0;}else{threshold=m.threshold;scale=m.scale;}
for(i=0;i<numSamps;i++){val=Math.random();output[i]=(val<threshold)?val*scale:0.0;}
that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.dust",{rate:"audio",inputs:{density:1.0}});flock.ugen.lfNoise=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.counter=0;that.model.level=0;that.gen=function(numSamps){var m=that.model,freq=inputs.freq.output[0],remain=numSamps,out=that.output,counter=m.counter,level=m.level,currSamp=0,sampsForLevel,i;freq=freq>0.001?freq:0.001;do{if(counter<=0){counter=that.sampleRate/freq;counter=counter>1?counter:1;level=Math.random();}
sampsForLevel=remain<counter?remain:counter;remain-=sampsForLevel;counter-=sampsForLevel;for(i=0;i<sampsForLevel;i++){out[currSamp]=level;currSamp++;}}while(remain);m.counter=counter;m.level=level;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.lfNoise",{rate:"audio",inputs:{freq:440}});flock.ugen.line=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,stepSize=m.stepSize,numSteps=m.numSteps,numLevelVals=numSteps>=numSamps?numSamps:numSteps,numEndVals=numSamps-numLevelVals,level=m.level,out=that.output,i;for(i=0;i<numLevelVals;i++){out[i]=level;numSteps--;level+=stepSize;}
if(numEndVals>0){for(i=0;i<numEndVals;i++){out[i]=level;}}
m.level=level;m.numSteps=numSteps;that.mulAdd(numSamps);};that.onInputChanged=function(){var m=that.model;m.start=that.inputs.start.output[0];m.end=that.inputs.end.output[0];m.numSteps=Math.round(that.inputs.duration.output[0]*that.sampleRate);if(m.numSteps===0){m.stepSize=0.0;m.level=m.end;}else{m.stepSize=(m.end-m.start)/m.numSteps;m.level=m.start;}
flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.line",{rate:"control"});flock.ugen.xLine=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,multiplier=m.multiplier,numSteps=m.numSteps,numLevelVals=numSteps>=numSamps?numSamps:numSteps,numEndVals=numSamps-numLevelVals,level=m.level,out=that.output,i;for(i=0;i<numLevelVals;i++){out[i]=level;numSteps--;level*=multiplier;}
if(numEndVals>0){for(i=0;i<numEndVals;i++){out[i]=level;}}
m.level=level;m.numSteps=numSteps;that.mulAdd(numSamps);};that.onInputChanged=function(){var m=that.model;flock.onMulAddInputChanged(that);m.start=that.inputs.start.output[0];if(m.start===0.0){m.start=Number.MIN_VALUE;}
m.end=that.inputs.end.output[0];m.numSteps=Math.round(that.inputs.duration.output[0]*that.sampleRate);m.multiplier=Math.pow(m.end/m.start,1.0/m.numSteps);m.level=m.start;};that.onInputChanged();return that;};flock.defaults("flock.ugen.xLine",{rate:"control"});flock.ugen.env={};flock.ugen.env.simpleASR=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var m=that.model,out=that.output,prevGate=m.previousGate,gate=that.inputs.gate.output[0],level=m.level,stage=m.stage,currentStep=stage.currentStep,stepInc=stage.stepInc,numSteps=stage.numSteps,targetLevel=m.targetLevel,stepsNeedRecalc=false,stageTime,i;if(prevGate<=0&&gate>0){targetLevel=that.inputs.sustain.output[0];stageTime=that.inputs.attack.output[0];stepsNeedRecalc=true;}else if(gate<=0&&currentStep>=numSteps){targetLevel=that.inputs.start.output[0];stageTime=that.inputs.release.output[0];stepsNeedRecalc=true;}
if(stepsNeedRecalc){numSteps=Math.round(stageTime*that.sampleRate);stepInc=(targetLevel-level)/numSteps;currentStep=0;}
for(i=0;i<numSamps;i++){out[i]=level;currentStep++;level=currentStep<numSteps?level+stepInc:currentStep===numSteps?targetLevel:level;}
m.level=level;m.targetLevel=targetLevel;m.previousGate=gate;stage.currentStep=currentStep;stage.stepInc=stepInc;stage.numSteps=numSteps;};that.init=function(){var m=that.model;that.onInputChanged();m.stage={currentStep:0,stepInc:0,numSteps:0};m.previousGate=0.0;m.level=that.inputs.start.output[0];m.targetLevel=that.inputs.sustain.output[0];};that.init();return that;};flock.defaults("flock.ugen.env.simpleASR",{rate:"control",inputs:{start:0.0,attack:0.01,sustain:1.0,release:1.0,gate:0.0}});flock.ugen.amplitude=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.model.previousValue=0.0;that.gen=function(numSamps){var m=that.model,source=that.inputs.source.output,out=that.output,prevAtt=m.attackTime,nextAtt=that.inputs.attack.output[0],prevRel=m.releaseTime,nextRel=that.inputs.release.output[0],prevVal=m.previousValue,attCoef=m.attackCoef,relCoef=m.releaseCoef,i,val,coef;if(nextAtt!==prevAtt){m.attackTime=nextAtt;attCoef=m.attackCoef=nextAtt===0.0?0.0:Math.exp(flock.LOG1/(nextAtt*that.sampleRate));}
if(nextRel!==prevRel){m.releaseTime=nextRel;relCoef=m.releaseCoef=(nextRel===0.0)?0.0:Math.exp(flock.LOG1/(nextRel*that.sampleRate));}
for(i=0;i<numSamps;i++){val=Math.abs(source[i]);coef=val<prevVal?relCoef:attCoef;out[i]=prevVal=val+(prevVal-val)*coef;}
m.previousValue=prevVal;that.mulAdd(numSamps);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.amplitude",{rate:"audio",inputs:{attack:0.01,release:0.01}});flock.ugen.normalize=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(){var max=that.inputs.max.output[0],source=that.inputs.source.output,i;that.output=flock.normalize(source,max);};that.onInputChanged();return that;};flock.defaults("flock.ugen.normalize",{rate:"audio",inputs:{max:1.0}});flock.ugen.out=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var sources=that.inputs.sources,buses=flock.enviro.shared.buses,bufStart=that.inputs.bus.output[0],expand=that.inputs.expand.output[0],i,j,source,rate,bus,inc,outIdx,k;if(typeof(sources.length)!=="number"){sources=[sources];}
for(i=0;i<expand;i++){for(j=0;j<sources.length;j++){source=sources[j];rate=source.rate;bus=buses[bufStart+i+j];inc=rate===flock.rates.AUDIO?1:0;outIdx=0;for(k=0;k<numSamps;k++,outIdx+=inc){bus[k]=bus[k]+source.output[outIdx];}}}};that.onInputChanged();return that;};flock.defaults("flock.ugen.out",{rate:"audio",inputs:{bus:0,expand:1}});flock.ugen["in"]=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.singleBusGen=function(){that.output=flock.enviro.shared.buses[that.inputs.bus.output[0]];};that.multiBusGen=function(numSamps){var busesInput=that.inputs.bus,enviroBuses=flock.enviro.shared.buses,out=that.output,i,j,busIdx;for(i=0;i<numSamps;i++){out[i]=0;for(j=0;j<busesInput.length;j++){busIdx=busesInput[j].output[0];out[i]+=enviroBuses[busIdx][i];}}};that.onInputChanged=function(){that.gen=flock.isIterable(that.inputs.bus)?that.multiBusGen:that.singleBusGen;flock.onMulAddInputChanged(that);};that.onInputChanged();return that;};flock.defaults("flock.ugen.in",{rate:"audio",inputs:{bus:0}});flock.ugen.audioIn=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var out=that.output,m=that.model,idx=m.idx,inputBuffer=m.inputBuffer,i;for(i=0;i<numSamps;i++){if(idx>=inputBuffer.length){inputBuffer=m.inputBuffers.shift()||[];idx=0;}
out[i]=idx<inputBuffer.length?inputBuffer[idx++]:0.0;}
m.idx=idx;m.inputBuffer=inputBuffer;that.mulAdd(numSamps);};that.onAudioData=function(data){that.model.inputBuffers.push(data);};that.setDevice=function(deviceIdx){deviceIdx=deviceIdx!==undefined?deviceIdx:that.inputs.device.output[0];that.mike.setMicrophone(deviceIdx);};that.init=function(){var m=that.model,mikeOpts=that.options.mike||{};mikeOpts.settings=mikeOpts.settings||{};mikeOpts.settings.sampleRate=String(mikeOpts.settings.sampleRate||flock.enviro.shared.audioSettings.rates.audio);that.mike=new Mike(mikeOpts);that.mike.on("ready",function(){that.setDevice();});that.mike.on("microphonechange",function(){this.start();});that.mike.on("data",that.onAudioData);m.inputBuffers=[];m.inputBuffer=[];m.idx=0;};that.onInputChanged=function(inputName){if(inputName==="device"){that.setDevice();return;}
flock.onMulAddInputChanged(that);};that.onInputChanged();that.init();return that;};flock.defaults("flock.ugen.audioIn",{rate:"audio",inputs:{device:0}});flock.ugen.scope=function(inputs,output,options){var that=flock.ugen(inputs,output,options),fps=options.fps||60;that.model.spf=Math.round(that.sampleRate/fps);that.model.bufIdx=0;that.model.scope=that.options.styles||{scaleY:0.75,strokeColor:"#777777",strokeWidth:3};that.model.scope.values=new Float32Array(that.model.spf);that.scopeView=flock.gfx.scopeView(that.options.canvas,that.model.scope);that.gen=function(numSamps){var m=that.model,spf=m.spf,bufIdx=m.bufIdx,buf=m.scope.values,i;for(i=0;i<numSamps;i++){buf[bufIdx]=that.inputs.source.output[i];if(bufIdx<spf){bufIdx+=1;}else{bufIdx=0;that.scopeView.refreshView();}}
m.bufIdx=bufIdx;};that.onInputChanged=function(){that.output=that.inputs.source.output;};that.onInputChanged();that.scopeView.refreshView();return that;};flock.defaults("flock.ugen.scope",{rate:"audio"});flock.ugen.mouse={};flock.ugen.mouse.cursor=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.options.axis=that.options&&that.options.axis?that.options.axis:"x";that.exponentialGen=function(numSamps){var m=that.model,scaledMouse=m.mousePosition/m.size,movingAvg=m.movingAvg,lag=that.inputs.lag.output[0],add=that.inputs.add.output[0],mul=that.inputs.mul.output[0],lagCoef=m.lagCoef,out=that.output,pow=Math.pow,i,max;if(lag!==lagCoef){lagCoef=lag===0?0.0:Math.exp(flock.LOG001/(lag*that.sampleRate));m.lagCoef=lagCoef;}
for(i=0;i<numSamps;i++){max=mul+add;scaledMouse=pow(max/add,scaledMouse)*add;movingAvg=scaledMouse+lagCoef*(movingAvg-scaledMouse);out[i]=movingAvg;}
m.movingAvg=movingAvg;};that.linearGen=function(numSamps){var m=that.model,scaledMouse=m.mousePosition/m.size,movingAvg=m.movingAvg,lag=that.inputs.lag.output[0],add=that.inputs.add.output[0],mul=that.inputs.mul.output[0],lagCoef=m.lagCoef,out=that.output,i;if(lag!==lagCoef){lagCoef=lag===0?0.0:Math.exp(flock.LOG001/(lag*that.sampleRate));m.lagCoef=lagCoef;}
for(i=0;i<numSamps;i++){movingAvg=scaledMouse+lagCoef*(movingAvg-scaledMouse);out[i]=movingAvg*mul+add;}
m.movingAvg=movingAvg;};that.noInterpolationGen=function(numSamps){var m=that.model,scaledMouse=m.mousePosition/m.size,add=that.inputs.add.output[0],mul=that.inputs.mul.output[0],out=that.output,i;for(i=0;i<numSamps;i++){out[i]=scaledMouse*mul+add;}};that.moveListener=function(e){var m=that.model,pos=e[m.eventProp],off;if(pos===undefined){off=$(e.target).offset();e.offsetX=e.clientX-off.left;e.offsetY=e.clientY-off.top;pos=e[m.eventProp];}
m.mousePosition=m.isWithinTarget?pos:0.0;};that.overListener=function(e){that.model.isWithinTarget=true;};that.outListener=function(e){var m=that.model;m.isWithinTarget=false;m.mousePosition=0.0;};that.downListener=function(e){that.model.isMouseDown=true;};that.upListener=function(e){var m=that.model;m.isMouseDown=false;m.mousePosition=0;};that.moveWhileDownListener=function(e){if(that.model.isMouseDown){that.moveListener(e);}};that.bindEvents=function(){var m=that.model,target=m.target,moveListener=that.moveListener;if(that.options.onlyOnMouseDown){target.mousedown(that.downListener);target.mouseup(that.upListener);moveListener=that.moveWhileDownListener;}
target.mouseover(that.overListener);target.mouseout(that.outListener);target.mousemove(moveListener);};that.onInputChanged=function(){flock.onMulAddInputChanged(that);var interp=that.options.interpolation;that.gen=interp==="none"?that.noInterpolationGen:interp==="exponential"?that.exponentialGen:that.linearGen;that.model.exponential=interp==="exponential";};that.init=function(){var m=that.model,options=that.options,axis=options.axis,target=$(options.target||window);if(axis==="x"||axis==="width"||axis==="horizontal"){m.eventProp="offsetX";m.size=target.width();}else{m.eventProp="offsetY";m.size=target.height();}
m.mousePosition=0;m.movingAvg=0;m.target=target;that.bindEvents();that.onInputChanged();};that.init();return that;};flock.defaults("flock.ugen.mouse.cursor",{rate:"control",inputs:{lag:0.5,add:0.0,mul:1.0}});flock.ugen.mouse.click=function(inputs,output,options){var that=flock.ugen(inputs,output,options);that.gen=function(numSamps){var out=that.output,m=that.model,i;for(i=0;i<numSamps;i++){out[i]=m.value;that.mulAdd(numSamps);}};that.mouseDownListener=function(e){that.model.value=1.0;};that.mouseUpListener=function(e){that.model.value=0.0;};that.init=function(){var m=that.model;m.target=typeof(that.options.target)==="string"?document.querySelector(that.options.target):that.options.target||window;m.value=0.0;m.target.addEventListener("mousedown",that.mouseDownListener,false);m.target.addEventListener("mouseup",that.mouseUpListener,false);that.onInputChanged();};that.onInputChanged=function(){flock.onMulAddInputChanged(that);};that.init();return that;};flock.defaults("flock.ugen.mouse.click",{rate:"control"});}(jQuery));