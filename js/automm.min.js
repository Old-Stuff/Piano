
var automm=automm||{};(function(){"use strict";fluid.defaults("automm.instrument",{gradeNames:["fluid.viewComponent","autoInit"],postInitFunction:"automm.instrument.postInitFunction",model:{afour:69,afourFreq:440,firstNote:60,octaves:1,octaveNotes:12,padding:50,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{width:50,height:200,stroke:"black",fill:"white",highlight:"yellow",notes:[]},black:{width:30,height:125,stroke:"black",fill:"black",highlight:"yellow",notes:[]}},keyTypes:{keyOne:{width:50,height:200,stroke:"black",fill:"white",highlight:"yellow"},keyTwo:{width:30,height:125,stroke:"black",fill:"black",highlight:"yellow"}}},events:{onNote:null,afterNote:null,afterInstrumentUpdate:null},components:{piano:{type:"automm.piano",container:"{instrument}.container",options:{model:{firstNote:"{instrument}.model.firstNote",octaves:"{instrument}.model.octaves",octaveNotes:"{instrument}.model.octaveNotes",padding:"{instrument}.model.padding",pattern:"{instrument}.model.pattern",keys:"{instrument}.model.keys",keyTypes:"{instrument}.model.keyTypes"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterInstrumentUpdate:"{instrument}.events.afterInstrumentUpdate"}}},oscillator:{type:"automm.oscillator",options:{model:{afour:"{instrument}.afour",afourFreq:"{instrument}.afourFreq",ocaveNotes:"{instrument}.octaveNotes"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterInstrumentUpdate:"{instrument}.events.afterInstrumentUpdate"}}}}});automm.instrument.postInitFunction=function(that){that.update=function(param,value){that.applier.requestChange(param,value);that.events.afterInstrumentUpdate.fire(param,value);return that;};};}());
(function(){"use strict";fluid.defaults("automm.oscillator",{gradeNames:["fluid.modelComponent","fluid.eventedComponent","autoInit"],preInitFunction:"automm.oscillator.preInitFunction",postInitFunction:"automm.oscillator.postInitFunction",model:{freq:440,osc:"flock.ugen.sinOsc",attack:0.25,sustain:0.6,release:0.5,gate:0,afour:69,afourFreq:440,octaveNotes:12},events:{onNote:null,afterNote:null,afterInstrumentUpdate:null},paramMap:{"freq":"carrier.freq","attack":"asr.attack","sustain":"asr.sustain","release":"asr.release","gate":"asr.gate"}});automm.oscillator.preInitFunction=function(that){that.osc=flock.synth({id:"carrier",ugen:that.model.osc,freq:that.model.freq,mul:{id:"asr",ugen:"flock.ugen.env.simpleASR",attack:that.model.attack,sustain:that.model.sustain,release:that.model.release}});};automm.oscillator.postInitFunction=function(that){that.applier.modelChanged.addListener("*",function(newModel,oldModel,changeSpec){var path=changeSpec[0].path,oscPath=that.options.paramMap[path];that.osc.input(oscPath,newModel[path]);});that.update=function(param,value){if(that.model.hasOwnProperty(param)){that.applier.requestChange(param,value);}};that.onNote=function(note){var freq=that.midiToFreq(note[0].id);that.update("freq",freq);that.update("gate",1);};that.afterNote=function(){that.update("gate",0);};that.midiToFreq=function(noteNum){return Math.pow(2,((noteNum-that.model.afour)/that.model.octaveNotes))*that.model.afourFreq;};flock.enviro.shared.play();that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterInstrumentUpdate.addListener(that.update);};}());
(function($){"use strict";fluid.defaults("automm.piano",{gradeNames:["fluid.viewComponent","autoInit"],preInitFunction:"automm.piano.preInitFunction",postInitFunction:"automm.piano.postInitFunction",model:{firstNote:60,octaves:1,octaveNotes:12,padding:50,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{width:50,height:200,stroke:"black",fill:"white",highlight:"yellow",notes:[]},black:{width:30,height:125,stroke:"black",fill:"black",highlight:"yellow",notes:[]}},keyTypes:{keyOne:{width:50,height:200,stroke:"black",fill:"white",highlight:"yellow"},keyTwo:{width:30,height:125,stroke:"black",fill:"black",highlight:"yellow"}}},events:{afterUpdate:null,onNote:null,afterNote:null,afterInstrumentUpdate:null},components:{eventBinder:{type:"automm.eventBinder",container:"{piano}.container",options:{events:{afterUpdate:"{piano}.events.afterUpdate",onNote:"{piano}.events.onNote",afterNote:"{piano}.events.afterNote"}}}}});automm.piano.preInitFunction=function(that){that.setup=function(){var i;that.model.keys.white.notes=[];that.model.keys.black.notes=[];for(i=that.model.firstNote;i<(that.model.firstNote+(that.model.octaves*that.model.octaveNotes));i+=1){that.model.keys[that.model.pattern[i%that.model.octaveNotes]].notes.push(i);}
that.model.whiteNotes=that.model.keys.white.notes.length;that.model.blackNotes=that.model.keys.black.notes.length;that.model.viewbox={width:(that.model.keys.white.width*that.model.whiteNotes)+that.model.padding,height:that.model.keys.white.height+that.model.padding};that.model.viewbox.dim="0 0 "+that.model.viewbox.width+" "+that.model.viewbox.height;};that.drawNote=function(noteType,x,y,id){var r=that.noteGroup.append("rect");r.style("stroke",noteType.stroke);r.style("fill",noteType.fill);r.attr("x",x);r.attr("y",y);r.attr("width",noteType.width);r.attr("height",noteType.height);r.attr("id",id);r.attr("class","note");r.attr("noteType",noteType.fill);};that.render=function(){var blackX=-(that.model.keys.black.width/2),prevNote,blackCount=0,i;if(that.model.keys.white.notes[0]>that.model.keys.black.notes[0]){blackX=blackX-that.model.keys.white.width+(that.model.keys.black.width/2);}
for(i=0;i<that.model.keys.white.notes.length;i+=1){if(that.model.keys.white.notes[0]>that.model.keys.black.notes[0]){that.drawNote(that.model.keys.white,(i*that.model.keys.white.width)+that.model.keys.black.width/2,0,that.model.keys.white.notes[i]);}else{that.drawNote(that.model.keys.white,i*that.model.keys.white.width,0,that.model.keys.white.notes[i]);}}
for(i=that.model.firstNote;i<(that.model.octaves*that.model.octaveNotes)+that.model.firstNote;i+=1){if(that.model.pattern[i%that.model.octaveNotes]==="black"){blackX=blackX+that.model.keys.white.width;that.drawNote(that.model.keys.black,blackX,0,that.model.keys.black.notes[blackCount]);blackCount=blackCount+1;}
if(that.model.pattern[i%that.model.octaveNotes]===prevNote){blackX=blackX+that.model.keys.white.width;}
prevNote=that.model.pattern[i%that.model.octaveNotes];}};that.draw=function(){that.setup();that.d3container=d3.select("#"+that.container.attr('id'));var svg=that.d3container.append("svg");svg.attr("style","height: 100%;");svg.attr("viewBox",that.model.viewbox.dim);that.noteGroup=svg.append("g");that.noteGroup.attr("transform","translate("+that.model.padding/2+","+that.model.padding/2+")");that.render();};that.update=function(param,value){that.applier.requestChange(param,value);that.container.html('');that.draw();that.events.afterUpdate.fire();};that.onNote=function(note){if($.inArray(parseInt(note[0].id,10),that.model.keys.white.notes)!==-1){note.css('fill',that.model.keys.white.highlight);}else{note.css('fill',that.model.keys.black.highlight);}};that.afterNote=function(note){if($.inArray(parseInt(note[0].id,10),that.model.keys.white.notes)!==-1){note.css('fill',that.model.keys.white.fill);}else{note.css('fill',that.model.keys.black.fill);}};};automm.piano.postInitFunction=function(that){that.draw();that.events.afterUpdate.fire();that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterInstrumentUpdate.addListener(that.update);};}(jQuery));
(function($){"use strict";fluid.defaults("automm.eventBinder",{gradeNames:["fluid.viewComponent","autoInit"],postInitFunction:"automm.eventBinder.postInitFunction",events:{afterUpdate:null,onNote:null,afterNote:null}});automm.eventBinder.postInitFunction=function(that){that.bindEvents=function(){var lastClicked={},isClicking=false;that.notes=that.container.find(".note");that.notes.each(function(i,note){note=$(note);note.mousedown(function(){lastClicked=note;isClicking=true;that.events.onNote.fire(note);});note.mouseup(function(){isClicking=false;that.events.afterNote.fire(note);lastClicked={};});note.hover(function(){if(isClicking){that.events.afterNote.fire(lastClicked);that.events.onNote.fire(note);}
lastClicked=note;});});};that.bindEvents();that.events.afterUpdate.addListener(that.bindEvents);};}(jQuery));