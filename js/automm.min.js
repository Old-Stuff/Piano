
var automm=automm||{};(function($){"use strict";fluid.defaults("automm.oscillator",{gradeNames:["fluid.modelComponent","fluid.eventedComponent","autoInit"],preInitFunction:"automm.oscillator.preInitFunction",postInitFunction:"automm.oscillator.postInitFunction",model:{freq:440,osc:"flock.ugen.sin",attack:0.25,sustain:0.7,release:0.5,gate:0,afour:69,afourFreq:440,octaveNotes:12,isShift:false},events:{onNote:null,afterNote:null,afterInstrumentUpdate:null},paramMap:{"freq":"carrier.freq","attack":"env.attack","sustain":"env.sustain","release":"env.release","gate":"env.gate"}});automm.oscillator.preInitFunction=function(that){var platform=navigator.platform||"";flock.enviro.shared=platform.indexOf("Linux")!==-1?flock.enviro({bufferSize:2048}):$.browser.mozilla&&platform==="Win32"?flock.enviro({bufferSize:4096}):flock.enviro.shared;that.osc=flock.synth.polyphonic({id:"carrier",ugen:that.model.osc,freq:that.model.freq,mul:{id:"env",ugen:"flock.ugen.env.simpleASR",attack:that.model.attack,sustain:that.model.sustain,release:that.model.release}});};automm.oscillator.postInitFunction=function(that){that.applier.modelChanged.addListener("*",function(newModel,oldModel,changeSpec){var path=changeSpec[0].path,oscPath=that.options.paramMap[path];that.osc.input(oscPath,newModel[path]);});that.update=function(param,value){if(that.model.hasOwnProperty(param)){that.applier.requestChange(param,value);}};that.onNote=function(note){var noteID=note[0].id,freq=that.midiToFreq(noteID);that.osc.noteOn(noteID,{"carrier.freq":freq});};that.afterNote=function(note){if(!that.isShift){that.osc.noteOff(note[0].id);}};that.midiToFreq=function(noteNum){return Math.pow(2,((noteNum-that.model.afour)/that.model.octaveNotes))*that.model.afourFreq;};flock.enviro.shared.play();that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterInstrumentUpdate.addListener(that.update);};}(jQuery));
var automm=automm||{};(function(){"use strict";fluid.defaults("automm.piano",{gradeNames:["fluid.viewComponent","autoInit"],preInitFunction:"automm.piano.preInitFunction",postInitFunction:"automm.piano.postInitFunction",model:{firstNote:60,octaves:1,octaveNotes:12,padding:50,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{width:50,height:200,stroke:"black",fill:"white",highlight:"yellow",notes:[]},black:{width:30,height:125,stroke:"black",fill:"black",highlight:"yellow",notes:[]}}},events:{afterUpdate:null,onNote:null,afterNote:null,afterInstrumentUpdate:null,afterNoteCalc:null,getNoteCalc:null}});automm.piano.preInitFunction=function(that){that.setup=function(){var i;that.model.keys.white.notes=[];that.model.keys.black.notes=[];for(i=that.model.firstNote;i<(that.model.firstNote+(that.model.octaves*that.model.octaveNotes));i+=1){that.model.keys[that.model.pattern[i%that.model.octaveNotes]].notes.push(i);}
that.model.whiteNotes=that.model.keys.white.notes.length;that.model.blackNotes=that.model.keys.black.notes.length;that.model.viewbox={width:(that.model.keys.white.width*that.model.whiteNotes)+that.model.padding,height:that.model.keys.white.height+that.model.padding};that.model.viewbox.dim="0 0 "+that.model.viewbox.width+" "+that.model.viewbox.height;};that.drawNote=function(noteType,x,y,id){var r=that.noteGroup.append("rect");r.style("stroke",noteType.stroke);r.style("fill",noteType.fill);r.attr("x",x);r.attr("y",y);r.attr("width",noteType.width);r.attr("height",noteType.height);r.attr("id",id);r.attr("class","note");r.attr("data-role","button");r.attr("noteType",noteType.fill);};that.render=function(){var blackX=-(that.model.keys.black.width/2),prevNote,blackCount=0,i;if(that.model.keys.white.notes[0]>that.model.keys.black.notes[0]){blackX=blackX-that.model.keys.white.width+(that.model.keys.black.width/2);}
for(i=0;i<that.model.keys.white.notes.length;i+=1){if(that.model.keys.white.notes[0]>that.model.keys.black.notes[0]){that.drawNote(that.model.keys.white,(i*that.model.keys.white.width)+that.model.keys.black.width/2,0,that.model.keys.white.notes[i]);}else{that.drawNote(that.model.keys.white,i*that.model.keys.white.width,0,that.model.keys.white.notes[i]);}}
for(i=that.model.firstNote;i<(that.model.octaves*that.model.octaveNotes)+that.model.firstNote;i+=1){if(that.model.pattern[i%that.model.octaveNotes]==="black"){blackX=blackX+that.model.keys.white.width;that.drawNote(that.model.keys.black,blackX,0,that.model.keys.black.notes[blackCount]);blackCount=blackCount+1;}
if(that.model.pattern[i%that.model.octaveNotes]===prevNote){blackX=blackX+that.model.keys.white.width;}
prevNote=that.model.pattern[i%that.model.octaveNotes];}};that.draw=function(){that.setup();that.d3container=d3.select("#"+that.container.attr('id')).select('#piano');var svg=that.d3container.append("svg");svg.attr("style","height: 100%;");svg.attr("viewBox",that.model.viewbox.dim);that.noteGroup=svg.append("g");that.noteGroup.attr("transform","translate("+that.model.padding/2+","+that.model.padding/2+")");that.noteGroup.attr("data-role","controlgroup");that.render();};that.update=function(param,value){that.applier.requestChange(param,value);that.container.children("#piano").html('');that.draw();that.events.afterUpdate.fire();};that.sendNoteCalc=function(){that.events.afterNoteCalc.fire(that.model.keys);};};automm.piano.postInitFunction=function(that){var pianoElements=that.container.find("#piano").length;if(that.model.auto&&pianoElements<1){that.container.append("<div id='piano'></div>");pianoElements=1;}
if(pianoElements>0){that.draw();that.events.afterUpdate.fire();that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterInstrumentUpdate.addListener(that.update);that.events.getNoteCalc.addListener(that.sendNoteCalc);}};}());
var automm=automm||{};(function(){"use strict";fluid.defaults("automm.grid",{gradeNames:["fluid.viewComponent","autoInit"],preInitFunction:"automm.grid.preInitFunction",postInitFunction:"automm.grid.postInitFunction",model:{auto:false,columns:8,rows:8,firstNote:60,octaves:1,octaveNotes:12,padding:50,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{width:50,height:50,stroke:"black",fill:"white",highlight:"yellow",notes:[]},black:{width:50,height:50,stroke:"black",fill:"black",highlight:"yellow",notes:[]}}},events:{afterUpdate:null,onNote:null,afterNote:null,afterInstrumentUpdate:null,afterNoteCalc:null,getNoteCalc:null}});automm.grid.preInitFunction=function(that){that.setup=function(){var noteNum=that.model.firstNote,i;that.model.keys.white.notes=[];that.model.keys.black.notes=[];for(i=0;i<(that.model.columns*that.model.rows);i+=1){that.model.keys[that.model.pattern[i%that.model.octaveNotes]].notes.push(noteNum);noteNum+=1;}
that.model.viewbox={width:(that.model.keys.white.width*that.model.columns)+that.model.padding,height:(that.model.keys.white.height*that.model.rows)+that.model.padding};that.model.viewbox.dim="0 0 "+that.model.viewbox.width+" "+that.model.viewbox.height;};that.drawNote=function(noteType,x,y,id){var r=that.noteGroup.append("rect");r.style("stroke",noteType.stroke);r.style("fill",noteType.fill);r.attr("x",x);r.attr("y",y);r.attr("width",noteType.width);r.attr("height",noteType.height);r.attr("id",id);r.attr("class","note");r.attr("data-role","button");r.attr("noteType",noteType.fill);};that.calcNoteDim=function(noteType,noteNumber,dim){var calculation=(noteNumber-that.model.firstNote);if(dim==="width"){calculation=calculation%that.model.columns;}else{calculation=Math.floor(calculation/that.model.columns);}
calculation=calculation*noteType[dim];return(calculation);};that.render=function(){var notePos={},noteNum,i;for(i=0;i<that.model.keys.white.notes.length;i+=1){noteNum=that.model.keys.white.notes[i];notePos.width=that.calcNoteDim(that.model.keys.white,noteNum,"width");notePos.height=that.calcNoteDim(that.model.keys.white,noteNum,"height");that.drawNote(that.model.keys.white,notePos.width,notePos.height,noteNum);}
for(i=0;i<that.model.keys.black.notes.length;i+=1){noteNum=that.model.keys.black.notes[i];notePos.width=that.calcNoteDim(that.model.keys.black,noteNum,"width");notePos.height=that.calcNoteDim(that.model.keys.black,noteNum,"height");that.drawNote(that.model.keys.black,notePos.width,notePos.height,noteNum);}};that.draw=function(){that.setup();that.d3container=d3.select("#"+that.container.attr('id')).select('#grid');var svg=that.d3container.append("svg");svg.attr("style","height: 100%;");svg.attr("viewBox",that.model.viewbox.dim);that.noteGroup=svg.append("g");that.noteGroup.attr("transform","translate("+that.model.padding/2+","+that.model.padding/2+")");that.noteGroup.attr("data-role","controlgroup");that.render();};that.update=function(param,value){that.applier.requestChange(param,value);that.container.children("#grid").html('');that.draw();that.events.afterUpdate.fire();};that.sendNoteCalc=function(){that.events.afterNoteCalc.fire(that.model.keys);};};automm.grid.postInitFunction=function(that){var gridElements=that.container.find("#grid").length;if(that.model.auto&&gridElements<1){that.container.append("<div id='grid'></div>");gridElements=1;}
if(gridElements>0){that.draw();that.events.afterUpdate.fire();that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterInstrumentUpdate.addListener(that.update);that.events.getNoteCalc.addListener(that.sendNoteCalc);}};}());
var automm=automm||{};(function(){"use strict";fluid.defaults("automm.instrument",{gradeNames:["fluid.viewComponent","autoInit"],postInitFunction:"automm.instrument.postInitFunction",model:{autoPiano:false,autoGrid:false,autoGui:false,columns:8,rows:8,afour:69,afourFreq:440,firstNote:60,octaves:1,octaveNotes:12,padding:0,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{fill:'#fff000',stroke:'#000000',highlight:'#ffffff'},black:{fill:'#ffa400',stroke:'#000000',highlight:'#000000'}}},events:{onNote:null,afterNote:null,afterInstrumentUpdate:null,afterGuiUpdate:null,afterNoteCalc:null,afterUpdate:null,getNoteCalc:null,afterPoly:null},components:{piano:{type:"automm.piano",container:"{instrument}.container",options:{model:{auto:"{instrument}.model.autoPiano",firstNote:"{instrument}.model.firstNote",octaves:"{instrument}.model.octaves",octaveNotes:"{instrument}.model.octaveNotes",padding:"{instrument}.model.padding",pattern:"{instrument}.model.pattern",keys:"{instrument}.model.keys"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterInstrumentUpdate:"{instrument}.events.afterInstrumentUpdate",afterNoteCalc:"{instrument}.events.afterNoteCalc",afterUpdate:"{instrument}.events.afterUpdate",getNoteCalc:"{instrument}.events.getNoteCalc"}}},grid:{type:"automm.grid",container:"{instrument}.container",options:{model:{auto:"{instrument}.model.autoGrid",columns:"{instrument}.model.columns",rows:"{instrument}.model.rows",firstNote:"{instrument}.model.firstNote",octaveNotes:"{instrument}.model.octaveNotes",padding:"{instrument}.model.padding",pattern:"{instrument}.model.pattern",keys:"{instrument}.model.keys"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterInstrumentUpdate:"{instrument}.events.afterInstrumentUpdate",afterNoteCalc:"{instrument}.events.afterNoteCalc",afterUpdate:"{instrument}.events.afterUpdate",getNoteCalc:"{instrument}.events.getNoteCalc"}}},oscillator:{type:"automm.oscillator",options:{model:{afour:"{instrument}.afour",afourFreq:"{instrument}.afourFreq",ocaveNotes:"{instrument}.octaveNotes"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterInstrumentUpdate:"{instrument}.events.afterInstrumentUpdate"}}},gui:{type:"automm.gui",container:"{instrument}.container",options:{model:{drawGui:"{instrument}.model.drawGui",firstNote:"{instrument}.model.firstNote",octaves:"{instrument}.model.octaves",octaveNotes:"{instrument}.model.octaveNotes",padding:"{instrument}.model.padding",pattern:"{instrument}.model.pattern",keys:"{instrument}.model.keys"},events:{afterGuiUpdate:"{instrument}.events.afterGuiUpdate"}}},eventBinder:{type:"automm.eventBinder",container:"{instrument}.container",options:{events:{afterUpdate:"{instrument}.events.afterUpdate",onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterPoly:"{instrument}.events.afterPoly"}}},highlighter:{type:"automm.highlighter",container:"{grid}.container",options:{model:{keys:"{instrument}.model.keys"},events:{onNote:"{instrument}.events.onNote",afterNote:"{instrument}.events.afterNote",afterNoteCalc:"{instrument}.events.afterNoteCalc",getNoteCalc:"{instrument}.events.getNoteCalc"}}}}});automm.instrument.postInitFunction=function(that){that.update=function(param,value){that.applier.requestChange(param,value);that.events.afterInstrumentUpdate.fire(param,value);return that;};that.events.afterGuiUpdate.addListener(that.update);};}());
var automm=automm||{};(function(){"use strict";fluid.defaults("automm.gui",{gradeNames:["fluid.viewComponent","autoInit"],model:{drawGui:false,afour:69,afourFreq:440,firstNote:60,octaves:1,octaveNotes:12,padding:0,pattern:['white','black','white','black','white','white','black','white','black','white','black','white'],keys:{white:{fill:'#fff000',stroke:'#000000',highlight:'#ffffff'},black:{fill:'#ffa400',stroke:'#000000',highlight:'#000000'}}},events:{afterGuiUpdate:null},preInitFunction:"automm.gui.preInitFunction",postInitFunction:"automm.gui.postInitFunction"});automm.gui.preInitFunction=function(that){that.init=function(){that.datgui=new dat.GUI({autoPlace:false});that.customContainer=that.container.children('#gui');that.datgui.close();that.customContainer.append(that.datgui.domElement);that.customContainer.attr('align','center').children().attr('align','left');that.datgui.octaves=that.datgui.add(that.model,'octaves',1,5);that.datgui.firstNote=that.datgui.add(that.model,'firstNote',24,84).step(1);that.datgui.style=that.datgui.addFolder('Style');that.datgui.padding=that.datgui.style.add(that.model,'padding',0,200);that.datgui.whiteKeys=that.datgui.style.addFolder('White Keys');that.datgui.whiteKeysFill=that.datgui.whiteKeys.addColor(that.model.keys.white,'fill');that.datgui.whiteKeysStroke=that.datgui.whiteKeys.addColor(that.model.keys.white,'stroke');that.datgui.whiteKeysHighlight=that.datgui.whiteKeys.addColor(that.model.keys.white,'highlight');that.datgui.blackKeys=that.datgui.style.addFolder('Black Keys');that.datgui.blackKeysFill=that.datgui.blackKeys.addColor(that.model.keys.black,'fill');that.datgui.blackKeysStroke=that.datgui.blackKeys.addColor(that.model.keys.black,'stroke');that.datgui.blackKeysHighlight=that.datgui.blackKeys.addColor(that.model.keys.black,'highlight');that.datgui.octaves.onChange(function(value){that.update("octaves",value);});that.datgui.firstNote.onChange(function(value){that.update("firstNote",value);});that.datgui.padding.onChange(function(value){that.update("padding",value);});that.datgui.whiteKeysFill.onChange(function(value){that.update("keys.white.fill",value);});that.datgui.whiteKeysStroke.onChange(function(value){that.update("keys.white.stroke",value);});that.datgui.whiteKeysHighlight.onChange(function(value){that.update("keys.white.highlight",value);});that.datgui.blackKeysFill.onChange(function(value){that.update("keys.black.fill",value);});that.datgui.blackKeysStroke.onChange(function(value){that.update("keys.black.stroke",value);});that.datgui.blackKeysHighlight.onChange(function(value){that.update("keys.black.highlight",value);});};that.update=function(param,value){that.applier.requestChange(param,value);that.events.afterGuiUpdate.fire(param,value);return that;};};automm.gui.postInitFunction=function(that){if(that.model.drawGui){if(that.container.find("gui").length<1){that.container.append("<div id='gui'></div>");}
that.init();that.container.append("<div class='buffer' style='height:50px;'></div>");}};}());
var automm=automm||{};(function($){"use strict";fluid.defaults("automm.highlighter",{gradeNames:["fluid.viewComponent","autoInit"],preInitFunction:"automm.highlighter.preInitFunction",postInitFunction:"automm.highlighter.postInitFunction",model:{keys:{white:{width:50,height:50,stroke:"black",fill:"white",highlight:"yellow",notes:[]},black:{width:50,height:50,stroke:"black",fill:"black",highlight:"yellow",notes:[]}}},events:{getNoteCalc:null,onNote:null,afterNote:null,afterNoteCalc:null}});automm.highlighter.preInitFunction=function(that){that.afterNoteCalc=function(newKeys){that.model.keys=newKeys;};that.onNote=function(note){if($.inArray(parseInt(note[0].id,10),that.model.keys.white.notes)!==-1){note.css('fill',that.model.keys.white.highlight);}else{note.css('fill',that.model.keys.black.highlight);}};that.afterNote=function(note){if($.inArray(parseInt(note[0].id,10),that.model.keys.white.notes)!==-1){note.css('fill',that.model.keys.white.fill);}else{note.css('fill',that.model.keys.black.fill);}};};automm.highlighter.postInitFunction=function(that){that.events.onNote.addListener(that.onNote);that.events.afterNote.addListener(that.afterNote);that.events.afterNoteCalc.addListener(that.afterNoteCalc);that.events.getNoteCalc.fire();};}(jQuery));
var automm=automm||{};(function($){"use strict";fluid.defaults("automm.eventBinder",{gradeNames:["fluid.viewComponent","autoInit"],preInitFunction:"automm.eventBinder.preInitFunction",postInitFunction:"automm.eventBinder.postInitFunction",model:{isShift:false},events:{afterUpdate:null,onNote:null,afterNote:null}});automm.eventBinder.preInitFunction=function(that){that.init=function(){var lastClicked={},isClicking=false;that.polyNotes=[];$(document).keydown(function(event){if(event.shiftKey===true){that.model.isShift=true;}});$(document).keyup(function(event){if(event.shiftKey===false&&that.model.isShift){that.model.isShift=false;that.afterShift();}});that.notes=that.container.find(".note");that.notes.each(function(i,note){note=$(note);note.mousedown(function(){lastClicked=note;isClicking=true;that.events.onNote.fire(note);});note.mouseup(function(){isClicking=false;if(!that.model.isShift){that.events.afterNote.fire(note);}
lastClicked={};});note.mouseover(function(){if(isClicking){if(!that.model.isShift){that.events.afterNote.fire(lastClicked);}
that.events.onNote.fire(note);}
lastClicked=note;});});};that.onNote=function(note){if(that.model.isShift){that.polyNotes[that.polyNotes.length]=note;}};that.afterShift=function(){fluid.each(that.polyNotes,function(note){that.events.afterNote.fire(note);});};};automm.eventBinder.postInitFunction=function(that){that.init();that.events.afterUpdate.addListener(that.bindEvents);that.events.onNote.addListener(that.onNote);};}(jQuery));